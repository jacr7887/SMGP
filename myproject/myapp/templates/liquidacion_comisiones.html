{% extends "base.html" %}
{% load static humanize %}
{% load querystring_tags %}

{% block title %}{{ title|default:"Liquidaci√≥n de Comisiones" }}{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
  /* Estilos para el modal y otros elementos (sin cambios) */
  .modal-custom { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(15, 18, 36, 0.9); }
  .modal-custom-content { background-color: #2a2f45; margin: 5% auto; padding: 20px; border: 1px solid var(--border-light, #555); width: 80%; max-width: 1000px; border-radius: var(--glass-border-radius, 8px); color: #fff; position: relative; box-shadow: var(--glass-box-shadow, 0 5px 15px rgba(0,0,0,0.5)); }
  .modal-custom-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-light, #444); padding-bottom: 10px; margin-bottom: 15px; }
  .modal-custom-title { margin: 0; font-size: 1.5rem; color: var(--text-light, #fff); }
  .modal-custom-close { color: #ccc; float: right; font-size: 30px; font-weight: bold; background: none; border: none; cursor: pointer; padding: 0 5px; }
  .modal-custom-close:hover, .modal-custom-close:focus { color: #fff; text-decoration: none; }
  .modal-custom-body { max-height: 65vh; overflow-y: auto; padding-right: 15px; }
  .fila-comision-pagada td { color: var(--text-muted, #6c757d) !important; text-decoration: line-through; }
  .switch { position: relative; display: inline-block; width: 50px; height: 24px; vertical-align: middle; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #4b5378; -webkit-transition: .4s; transition: .4s; border-radius: 24px; }
  .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; -webkit-transition: .4s; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: var(--success, #28a745); }
  input:focus + .slider { box-shadow: 0 0 1px var(--success, #28a745); }
  input:checked + .slider:before { -webkit-transform: translateX(26px); -ms-transform: translateX(26px); transform: translateX(26px); }
  .header-actions { justify-content: center; gap: 1rem; }
  @media (max-width: 768px) {
    .header-actions { flex-direction: column; align-items: center; }
    .page-list-view .header-actions .nav_link { width: auto; min-width: 220px; margin-bottom: 0.8rem; }
  }

  /* --- [NUEVO] Estilos para el pie de p√°gina del modal redise√±ado --- */
  .modal-custom-footer {
    display: flex;
    flex-wrap: wrap; /* Permite que los elementos pasen a la siguiente l√≠nea si no caben */
    justify-content: space-between; /* Separa los grupos de inputs y botones */
    align-items: flex-end; /* Alinea todo en la parte inferior */
    gap: 1rem; /* Espacio entre los grupos */
    border-top: 1px solid var(--border-light, #444);
    padding-top: 15px;
    margin-top: 20px;
  }

  .footer-inputs-group {
    display: flex;
    gap: 1rem; /* Espacio entre el campo de fecha y el de archivo */
    flex-grow: 1; /* Permite que este grupo crezca para ocupar espacio */
  }

  .footer-actions-group {
    display: flex;
    gap: 0.5rem; /* Espacio entre los botones de acci√≥n */
  }

  /* Ajustes para que los botones del footer no sean gigantes */
  .modal-custom-footer .btn {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
  }

  /* Estilo para el nombre del archivo */
  .file-name-display {
    color: var(--text-muted);
    font-size: 0.85rem;
    margin-left: 10px;
    vertical-align: middle;
  }
</style>
{% endblock extra_css %}

{% block content %}
<div class="dark-container page-list-view" role="main" aria-labelledby="main-heading-liquidacion">
  <section>
    <div class="list-header">
      <h1 id="main-heading-liquidacion" class="main-title">{{ page_heading|default:"üí∏ Liquidaci√≥n de Comisiones Pendientes" }}</h1>
      <div class="header-actions">
        <a href="{% url 'myapp:registro_comision_list' %}" class="nav_link">Ver Todos los Registros</a>
        <a href="{% url 'myapp:historial_liquidaciones_list' %}" class="nav_link">Ver Historial</a>
      </div>
    </div>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show compact-form" role="alert" style="margin-bottom: 1rem;">
          {{ message|escape }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>
      {% endfor %}
    {% endif %}

    <form method="get" class="search-form mb-3" action="." aria-label="Formulario de b√∫squeda de intermediarios">
      <input
        type="text"
        name="search"
        class="search-input"
        placeholder="üîç Buscar Intermediario por Nombre, C√≥digo o RIF..."
        value="{{ search_query_param_value|default_if_none:'' }}"
        aria-label="Campo de b√∫squeda de intermediarios"
      />
      <button type="submit" class="nav_link">Buscar</button>
      <a href="{% url 'myapp:liquidacion_comisiones' %}" class="nav_link" style="margin-left: 10px;" title="Limpiar b√∫squeda">Limpiar</a>
    </form>

    {% if liquidacion_data %}
      <div class="table-container glass-card">
        <table class="data-table">
          <thead>
            <tr>
              {% for field_key, field_label, is_sortable in ordering_options_display %}
              <th class="sort-header">
                <a href="?{% query_transform sort=field_key order=current_order|toggle_order:'asc' search=search_query_param_value page=1 %}">
                  {{ field_label }}
                  {% if current_sort == field_key %}<span>{% if current_order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}</span>{% else %}<span>‚ÜïÔ∏è</span>{% endif %}
                </a>
              </th>
              {% endfor %}
              <th class="actions-header">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for item in liquidacion_data %}
            <tr id="intermediario-summary-row-{{ item.intermediario.id }}">
              <td>
                <a href="{% url 'myapp:intermediario_detail' item.intermediario.pk %}" title="{{item.intermediario.nombre_completo}}">
                  {{ item.intermediario.codigo }}
                </a>
              </td>
              <td>{{ item.intermediario.nombre_completo|truncatechars:30 }}</td>
              <td class="text-end" id="total-directa-interm-{{ item.intermediario.id }}">{{ item.total_directa_pendiente|floatformat:2|intcomma }}</td>
              <td class="text-end" id="total-override-interm-{{ item.intermediario.id }}">{{ item.total_override_pendiente|floatformat:2|intcomma }}</td>
              <td class="text-end" id="total-general-interm-{{ item.intermediario.id }}"><strong>{{ item.total_general_pendiente|floatformat:2|intcomma }}</strong></td>
              <td class="actions" id="actions-cell-interm-{{ item.intermediario.id }}">
                <div class="action-group">
                  <button type="button" class="nav_link btn-sm open-modal-button" data-modal-id="detalleComisionesModal-{{ item.intermediario.id }}">
                    üí≤ Liquidar / Detalle
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if is_paginated %}
      <nav aria-label="Navegaci√≥n de p√°ginas de liquidaciones">
        <div class="django-pagination">
          <span class="pagination-current">
            P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
          </span>
          {% if page_obj.has_previous %}
            <a href="?{% query_transform page=1 %}" class="btn-pagination" aria-label="Primera p√°gina">¬´ Primera</a>
            <a href="?{% query_transform page=page_obj.previous_page_number %}" class="btn-pagination" aria-label="P√°gina anterior">‚Äπ Anterior</a>
          {% endif %}
          {% if page_obj.has_next %}
            <a href="?{% query_transform page=page_obj.next_page_number %}" class="btn-pagination" aria-label="Siguiente p√°gina">Siguiente ‚Ä∫</a>
            <a href="?{% query_transform page=page_obj.paginator.num_pages %}" class="btn-pagination" aria-label="√öltima p√°gina">√öltima ¬ª</a>
          {% endif %}
        </div>
      </nav>
      {% endif %}

      {% for item in liquidacion_data %}
      <div class="modal-custom" id="detalleComisionesModal-{{ item.intermediario.id }}">
        <div class="modal-custom-content dark-group">
          <div class="modal-custom-header">
            <h5 class="modal-custom-title dark-label">Liquidar Comisiones: {{ item.intermediario.nombre_completo }} ({{ item.intermediario.codigo }})</h5>
            <button type="button" class="modal-custom-close close-modal-button" data-modal-id="detalleComisionesModal-{{ item.intermediario.id }}" aria-label="Close">√ó</button>
          </div>
          
          <form method="post" action="{% url 'myapp:marcar_comisiones_pagadas' %}" class="compact-form liquidar-multiples-form" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="intermediario_id_pago" value="{{ item.intermediario.id }}">
            
            <div class="modal-custom-body">
              {% if item.detalle_comisiones %}
                <p><strong>Total Pendiente: {{ item.total_general_pendiente|floatformat:2|intcomma }} Bs.</strong></p>
                
                <div class="table-responsive mb-3">
                  <table class="data-table table-sm">
                    <thead>
                      <tr>
                        <th><label class="switch" title="Seleccionar Todas"><input type="checkbox" class="select_all_comisiones_modal" data-modal-id="detalleComisionesModal-{{ item.intermediario.id }}"><span class="slider"></span></label></th>
                        <th>ID</th><th>Tipo</th><th>Origen</th><th>Monto Pago Cliente</th><th>Vendedor (Override)</th><th>F. C√°lculo</th><th class="text-end">Monto Comisi√≥n</th><th>Estado</th><th>F. Pago</th><th>Liquid√≥</th><th>Comprobante</th><th>Acci√≥n Indiv.</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for comision in item.detalle_comisiones %}
                      <tr id="comision-row-{{ comision.pk }}" class="{% if comision.estatus_pago_comision == 'PAGADA' %}fila-comision-pagada{% endif %}">
                        <td>{% if comision.estatus_pago_comision == 'PENDIENTE' %}<label class="switch"><input type="checkbox" name="comisiones_a_pagar_ids" value="{{ comision.id }}" class="comision_checkbox_modal_{{ item.intermediario.id }}"><span class="slider"></span></label>{% endif %}</td>
                        <td>{{ comision.id }}</td><td>{{ comision.get_tipo_comision_display }}</td>
                        <td>{% if comision.factura_origen %}<a href="{% url 'myapp:factura_detail' comision.factura_origen.pk %}">F-{{ comision.factura_origen.numero_recibo|default_if_none:comision.factura_origen_id }}</a>{% elif comision.pago_cliente %}<a href="{% url 'myapp:pago_detail' comision.pago_cliente.pk %}">P-{{ comision.pago_cliente.referencia_pago|default_if_none:comision.pago_cliente_id }}</a>{% else %}N/A{% endif %}</td>
                        <td>{{ comision.pago_cliente.monto_pago|floatformat:2|intcomma|default:"-" }}</td>
                        <td>{{ comision.intermediario_vendedor.codigo|default:"-" }}</td>
                        <td>{{ comision.fecha_calculo|date:"d/m/y" }}</td>
                        <td class="text-end">{{ comision.monto_comision|floatformat:2|intcomma }}</td>
                        <td id="estatus-comision-{{ comision.pk }}">{{ comision.get_estatus_pago_comision_display }}</td>
                        <td id="fecha-pago-comision-{{ comision.pk }}">{{ comision.fecha_pago_a_intermediario|date:"d/m/y"|default:"-" }}</td>
                        <td id="usuario-liquido-comision-{{ comision.pk }}">{{ comision.usuario_que_liquido.username|default:"-" }}</td>
                        <td id="comprobante-comision-{{ comision.pk }}">
                          {% if comision.comprobante_pago %}
                            <a href="{{ comision.comprobante_pago.url }}" class="file-popup-trigger" data-popup-title="Comprobante Comisi√≥n #{{ comision.pk }}">üìé Ver</a>
                          {% else %}
                            -
                          {% endif %}
                        </td>
                        <td class="action-buttons-cell">{% if comision.estatus_pago_comision == 'PENDIENTE' %}<button type="button" class="btn btn-sm btn-success marcar-pagada-btn" data-comision-id="{{ comision.pk }}" data-url="{% url 'myapp:marcar_comision_pagada_ajax' %}">Pagar</button>{% endif %}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <p>No hay comisiones pendientes detalladas para este intermediario.</p>
              {% endif %}
            </div>

            <!-- [INICIO] Pie de p√°gina del modal redise√±ado -->
            <div class="modal-custom-footer">
              <div class="footer-inputs-group">
                <div class="dark-group">
                  <label for="fecha_pago_efectiva_modal_{{item.intermediario.id}}" class="dark-label" style="margin-bottom: 0.25rem;">Fecha de Pago:</label>
                  <input type="text" name="fecha_pago_efectiva" id="fecha_pago_efectiva_modal_{{item.intermediario.id}}" class="search-input" placeholder="{% now 'd/m/Y' %}" value="{% now 'd/m/Y' %}">
                </div>
                <div class="dark-group">
                  <label class="dark-label" style="margin-bottom: 0.25rem;">Comprobante:</label>
                  <input type="file" name="comprobante_pago_liquidacion" id="comprobante_pago_liquidacion-{{ item.intermediario.id }}" style="display: none;" onchange="updateFileName(this)">
                  <label for="comprobante_pago_liquidacion-{{ item.intermediario.id }}" class="btn btn-info" style="cursor: pointer;">üìé Seleccionar</label>
                  <span id="file-name-{{ item.intermediario.id }}" class="file-name-display"></span>
                </div>
              </div>
              <div class="footer-actions-group">
                {% if item.detalle_comisiones %}
                  <button type="submit" class="btn btn-success">‚úîÔ∏è Liquidar Seleccionadas</button>
                {% endif %}
                <button type="button" class="btn btn-danger close-modal-button" data-modal-id="detalleComisionesModal-{{ item.intermediario.id }}">üö´ Cancelar</button>
              </div>
            </div>
            <!-- [FIN] Pie de p√°gina del modal redise√±ado -->
          </form>
        </div>
      </div>
      {% endfor %}

    {% else %}
      <div class="alert alert-info mt-3">
        {% if search_query_param_value %}
        No se encontraron intermediarios que coincidan con "{{ search_query_param_value|escape }}" y tengan comisiones pendientes.
        {% else %}
        üéâ ¬°Excelente! No hay comisiones pendientes de liquidaci√≥n en este momento.
        {% endif %}
      </div>
    {% endif %}
  </section>
</div>
{% endblock content %}

{% block extra_js %}
<script>
// Funci√≥n para mostrar el nombre del archivo seleccionado
function updateFileName(input) {
    const fileId = input.id;
    const intermediarioId = fileId.split('-').pop();
    const fileNameDisplay = document.getElementById(`file-name-${intermediarioId}`);
    
    if (input.files && input.files.length > 0) {
        fileNameDisplay.textContent = input.files[0].name;
    } else {
        fileNameDisplay.textContent = '';
    }
}

document.addEventListener('DOMContentLoaded', function () {
    // --- L√≥gica para Modales Personalizados (Apertura/Cierre) ---
    const openModalButtons = document.querySelectorAll('.open-modal-button');
    const closeModalButtons = document.querySelectorAll('.close-modal-button');
    openModalButtons.forEach(button => {button.addEventListener('click', () => {const modalId=button.dataset.modalId; const modal=document.getElementById(modalId); if(modal){modal.style.display='block'; modal.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked=false);}});});
    closeModalButtons.forEach(button => {button.addEventListener('click', () => {const modal=button.closest('.modal-custom'); if(modal){modal.style.display='none';}});});
    window.addEventListener('click', (event) => {document.querySelectorAll('.modal-custom').forEach(modal => {if(event.target===modal){modal.style.display='none';}});});
    document.querySelectorAll('.select_all_comisiones_modal').forEach(function(selectAllCheckboxInput) {selectAllCheckboxInput.addEventListener('change', function() {const modalId=this.dataset.modalId || (this.closest('.modal-custom') ? this.closest('.modal-custom').id : null); const modalContent=modalId ? document.getElementById(modalId) : null; if(modalContent){const isChecked=this.checked; modalContent.querySelectorAll('input[name="comisiones_a_pagar_ids"]').forEach(function(checkbox){checkbox.checked=isChecked;});}});});
    
    // --- L√≥gica AJAX para Marcar Comisi√≥n Individual como Pagada ---
    const csrfTokenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    const csrfToken = csrfTokenInput ? csrfTokenInput.value : null;

    if (!csrfToken) {
        console.warn('Liquidaciones AJAX: Token CSRF no encontrado en la p√°gina. Las acciones AJAX podr√≠an fallar.');
    }

    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('marcar-pagada-btn')) {
            event.preventDefault(); 

            const button = event.target; 
            const comisionId = button.dataset.comisionId; 
            const url = button.dataset.url;

            if (!csrfToken) { 
                alert('Error de configuraci√≥n: Token CSRF ausente. No se puede realizar la acci√≥n.'); 
                return; 
            }
            if (!url) {
                console.error('URL para la acci√≥n AJAX no encontrada en el data-url del bot√≥n.');
                alert('Error de configuraci√≥n: URL de la acci√≥n no definida.');
                return;
            }

            button.disabled = true; 
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Pagando...';
            
            const formData = new FormData(); 
            formData.append('comision_id', comisionId);

            fetch(url, { 
                method: 'POST', 
                headers: { 'X-CSRFToken': csrfToken }, 
                body: formData 
            })
            .then(response => { 
                if (!response.ok) { 
                    return response.json()
                        .then(errData => { 
                            throw new Error(errData.message || `Error del servidor: ${response.status} ${response.statusText}`); 
                        })
                        .catch(() => {
                            throw new Error(`Error del servidor: ${response.status} ${response.statusText}`);
                        });
                } 
                return response.json(); 
            })
            .then(data => {
                const comisionRow = document.getElementById(`comision-row-${comisionId}`);
                if (data.status === 'success' || data.status === 'info') {
                    if (comisionRow) {
                        const estatusCell = comisionRow.querySelector(`#estatus-comision-${comisionId}`);
                        const fechaPagoCell = comisionRow.querySelector(`#fecha-pago-comision-${comisionId}`);
                        const usuarioLiquidoCell = comisionRow.querySelector(`#usuario-liquido-comision-${comisionId}`);
                        
                        if (estatusCell) estatusCell.textContent = data.nuevo_estatus;
                        if (fechaPagoCell) { 
                            if (data.fecha_pago) {
                                const parts = data.fecha_pago.split('-');
                                if (parts.length === 3) {
                                    fechaPagoCell.textContent = `${parts[2]}/${parts[1]}/${parts[0]}`;
                                } else {
                                    fechaPagoCell.textContent = data.fecha_pago; 
                                }
                            } else {
                                fechaPagoCell.textContent = '-';
                            }
                        }
                        if (usuarioLiquidoCell) usuarioLiquidoCell.textContent = data.usuario_liquido || 'N/A';
                        comisionRow.classList.add('fila-comision-pagada');
                    }
                    button.textContent = data.status === 'success' ? 'Pagada' : 'Ya Pagada';
                    button.classList.remove('btn-success'); 
                    button.classList.add(data.status === 'success' ? 'btn-outline-secondary' : 'btn-outline-info'); 
                    button.disabled = true;
                    if (comisionRow) { 
                        const checkboxInput = comisionRow.querySelector('input[type="checkbox"][name="comisiones_a_pagar_ids"]'); 
                        if (checkboxInput) { 
                            const switchLabel = checkboxInput.closest('.switch'); 
                            if (switchLabel) { 
                                switchLabel.innerHTML = ''; 
                                switchLabel.style.cursor = 'default'; 
                            }
                        }
                    }
                    if (data.intermediario_id && data.nuevos_totales) {
                        const formatCurrencyForDisplay = (valueStr) => {
                            const num = parseFloat(String(valueStr));
                            if (isNaN(num)) return '0,00';
                            return num.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        };

                        const directaCell = document.getElementById(`total-directa-interm-${data.intermediario_id}`);
                        const overrideCell = document.getElementById(`total-override-interm-${data.intermediario_id}`);
                        const generalCell = document.getElementById(`total-general-interm-${data.intermediario_id}`);
                        
                        if (directaCell) directaCell.textContent = formatCurrencyForDisplay(data.nuevos_totales.directa);
                        if (overrideCell) overrideCell.textContent = formatCurrencyForDisplay(data.nuevos_totales.override);
                        if (generalCell) generalCell.innerHTML = `<strong>${formatCurrencyForDisplay(data.nuevos_totales.general)}</strong>`;
                        
                        if (parseFloat(String(data.nuevos_totales.general)) <= 0) { 
                            const iRow = document.getElementById(`intermediario-summary-row-${data.intermediario_id}`);
                            if (iRow) { 
                                const actionsCell = iRow.querySelector(`#actions-cell-interm-${data.intermediario_id}`); 
                                if (actionsCell) { 
                                    const btnLiq = actionsCell.querySelector('.open-modal-button'); 
                                    if (btnLiq) { 
                                        btnLiq.style.display = 'none'; 
                                        let msgS = actionsCell.querySelector('.text-success.mensaje-liquidado'); 
                                        if (!msgS) { 
                                            msgS = document.createElement('span'); 
                                            msgS.className = 'text-success mensaje-liquidado'; 
                                            const ag = actionsCell.querySelector('.action-group'); 
                                            if(ag) ag.appendChild(msgS); else actionsCell.appendChild(msgS);
                                        } 
                                        msgS.textContent = 'Liquidado ‚úîÔ∏è';
                                    }
                                }
                            }
                        }
                    }
                    console.log(data.status === 'success' ? '√âxito AJAX:' : 'Info AJAX:', data.message);
                } else {
                    console.error('Error AJAX devuelto por el servidor:', data.message); 
                    alert('Error al procesar la solicitud: ' + data.message);
                    button.disabled = false; 
                    button.innerHTML = 'Pagar';
                }
            })
            .catch(error => {
                console.error('Error en la petici√≥n FETCH:', error); 
                alert('Error de red o del servidor. Por favor, intente de nuevo. Detalle: ' + error.message);
                button.disabled = false; 
                button.innerHTML = 'Pagar';
            });
        }
    });
});
</script>
{% endblock extra_js %}