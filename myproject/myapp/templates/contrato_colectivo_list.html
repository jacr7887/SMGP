{% extends "home.html" %}
{% load static %}
{% load querystring_tags %} 
{% load humanize %}

{% block content %}
<div class="container" role="main" aria-labelledby="main-heading">
  <section>
    <h1 id="main-heading">ğŸ¢ Listado Completo de Contratos Colectivos</h1>

    <div class="header-actions">
      {% if perms.myapp.add_contratocolectivo %}
      <a href="{% url 'myapp:contrato_colectivo_create' %}" class="nav_link" aria-label="Crear nuevo contrato colectivo">
        â• Nuevo Contrato Colectivo
      </a>
      {% endif %}
    </div>

    <form method="get" class="search-form mb-3" aria-label="Formulario de bÃºsqueda de contratos colectivos">
      <input
        type="text"
        name="search"
        placeholder="ğŸ” Buscar (NÂ° Contrato, RazÃ³n Social, RIF...)"
        value="{{ search_query|escape }}"
        aria-label="Campo de bÃºsqueda global"
        class="search-input"
      />
      <button type="submit" class="nav_link">Buscar</button>
      <a href="{% url 'myapp:contrato_colectivo_list' %}" class="nav_link" style="margin-left: 10px;" title="Limpiar bÃºsqueda y filtros">Limpiar</a>
    </form>

    <div class="table-container" role="region" aria-labelledby="table-caption">
      <table class="data-table" role="table">
        <caption id="table-caption" class="visually-hidden">
          Lista completa de contratos colectivos registrados. Haga clic en las cabeceras para ordenar.
        </caption>
        <thead role="rowgroup">
          <tr role="row">
            <th class="sort-header {% if current_sort == 'numero_contrato' %}active{% endif %}" role="columnheader"><a href="?{% query_transform sort='numero_contrato' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">ğŸ“„ NÂ° Contrato {% if current_sort == 'numero_contrato' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            <th class="sort-header {% if current_sort == 'razon_social' %}active{% endif %}" role="columnheader"><a href="?{% query_transform sort='razon_social' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">ğŸ¢ RazÃ³n Social {% if current_sort == 'razon_social' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            <th class="sort-header {% if current_sort == 'rif' %}active{% endif %}" role="columnheader"><a href="?{% query_transform sort='rif' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">ğŸ†” RIF {% if current_sort == 'rif' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            <th class="sort-header {% if current_sort == 'ramo' %}active{% endif %}" role="columnheader"><a href="?{% query_transform sort='ramo' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">ğŸŒ¿ Ramo {% if current_sort == 'ramo' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            <th class="sort-header {% if current_sort == 'fecha_inicio_vigencia' %}active{% endif %}" role="columnheader"><a href="?{% query_transform sort='fecha_inicio_vigencia' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">â¡ï¸ Inicio Vig. {% if current_sort == 'fecha_inicio_vigencia' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            <th class="sort-header {% if current_sort == 'fecha_fin_vigencia' %}active{% endif %}" role="columnheader"><a href="?{% query_transform sort='fecha_fin_vigencia' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">â¹ï¸ Fin Vig. {% if current_sort == 'fecha_fin_vigencia' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            <th class="sort-header text-center {% if current_sort == 'periodo_vigencia_meses' %}active{% endif %}" role="columnheader"><a href="?{% query_transform sort='periodo_vigencia_meses' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">â³ Dur. (M) {% if current_sort == 'periodo_vigencia_meses' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            <th class="sort-header {% if current_sort == 'tarifa_aplicada__id' %}active{% endif %}" role="columnheader">
              <a href="?{% query_transform sort='tarifa_aplicada__id' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">
                ğŸ·ï¸ Tarifa {% if current_sort == 'tarifa_aplicada__id' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}
              </a>
            </th>
            <th class="sort-header text-end {% if current_sort == 'monto_total' %}active{% endif %}" role="columnheader"><a href="?{% query_transform sort='monto_total' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">ğŸ’° Prima Total {% if current_sort == 'monto_total' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            
            {# --- CABECERA CUOTA CORREGIDA --- #}
            <th class="sort-header text-end {% if current_sort == 'monto_cuota_estimada' %}active{% endif %}" role="columnheader">
                <a href="?{% query_transform sort='monto_cuota_estimada' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">
                    ğŸ’² Cuota {% if current_sort == 'monto_cuota_estimada' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}
                </a>
            </th>
            <th class="sort-header {% if current_sort == 'forma_pago' %}active{% endif %}" role="columnheader"><a href="?{% query_transform sort='forma_pago' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">ğŸ’³ F. Pago {% if current_sort == 'forma_pago' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            
            {# --- CABECERA CUOTAS CORREGIDA --- #}
            <th class="sort-header text-end {% if current_sort == 'cantidad_cuotas_estimadas' %}active{% endif %}" role="columnheader">
                <a href="?{% query_transform sort='cantidad_cuotas_estimadas' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">
                    ğŸ”¢ Cuotas {% if current_sort == 'cantidad_cuotas_estimadas' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}
                </a>
            </th>

            <th class="sort-header text-end {% if current_sort == 'pagos_realizados' %}active{% endif %}" role="columnheader"><a href="?{% query_transform sort='pagos_realizados' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">âœ… Pagos R. {% if current_sort == 'pagos_realizados' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            <th class="sort-header text-end {% if current_sort == 'cantidad_empleados' %}active{% endif %}" role="columnheader"><a href="?{% query_transform sort='cantidad_empleados' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">ğŸ‘¥ Empleados {% if current_sort == 'cantidad_empleados' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            <th class="sort-header {% if current_sort == 'estatus' %}active{% endif %}" role="columnheader"><a href="?{% query_transform sort='estatus' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">ğŸš¦ Estatus Vig. {% if current_sort == 'estatus' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            <th class="sort-header {% if current_sort == 'intermediario__nombre_completo' %}active{% endif %}" role="columnheader"><a href="?{% query_transform sort='intermediario__nombre_completo' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">ğŸ¤ Intermediario {% if current_sort == 'intermediario__nombre_completo' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            <th class="sort-header text-center {% if current_sort == 'activo' %}active{% endif %}" role="columnheader"><a href="?{% query_transform sort='activo' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">ğŸ’¡ Activo {% if current_sort == 'activo' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            <th role="columnheader">âš™ï¸ Acciones</th>
          </tr>
        </thead>
        <tbody role="rowgroup">
          {% for contrato in object_list %}
          <tr role="row">
            <td role="cell"><a href="{% url 'myapp:contrato_colectivo_detail' contrato.pk %}" title="Ver detalle">{{ contrato.numero_contrato|escape|default:"-" }}</a></td>
            <td role="cell">{{ contrato.razon_social|escape|default:"-" }}</td>
            <td role="cell">{{ contrato.rif|escape|default:"-" }}</td>
            <td role="cell">{{ contrato.get_ramo_display|escape }}</td>
            <td role="cell">{{ contrato.fecha_inicio_vigencia|date:"d/m/Y"|default:"-" }}</td>
            <td role="cell">{{ contrato.fecha_fin_vigencia|date:"d/m/Y"|default:"-" }}</td>
            <td class="text-center" role="cell">{{ contrato.periodo_vigencia_meses|default:"-" }}</td>
            <td role="cell" title="{{ contrato.tarifa_aplicada }}">
              {% if contrato.tarifa_aplicada %}{{ contrato.tarifa_aplicada.id|default:"-" }}{% else %}-{% endif %}
            </td>
            <td class="text-end" role="cell">${{ contrato.monto_total|floatformat:2|intcomma|default:"0.00" }}</td>
            
            {# --- CELDA CUOTA CORREGIDA --- #}
            <td class="text-end" role="cell">${{ contrato.monto_cuota_estimada|floatformat:2|intcomma|default:"-" }}</td>
            <td role="cell">{{ contrato.get_forma_pago_display|escape }}</td>
            
            {# --- CELDA CUOTAS CORREGIDA --- #}
            <td class="text-end" role="cell">{{ contrato.cantidad_cuotas_estimadas|default:"-" }}</td>

            <td class="text-end" role="cell">{{ contrato.pagos_realizados|default:"0" }}</td>
            <td class="text-end" role="cell">{{ contrato.cantidad_empleados|intcomma|default:"-" }}</td>
            <td role="cell"><span class="badge {% if contrato.estatus == 'VIGENTE' %}badge-success{% elif contrato.estatus == 'VENCIDO' %}badge-danger{% else %}badge-warning{% endif %}">{{ contrato.get_estatus_display|escape }}</span></td>
            <td role="cell">{{ contrato.intermediario.nombre_completo|escape|default:"-" }}</td>
            <td class="text-center" role="cell">{% if contrato.activo %}âœ…{% else %}ğŸ”´{% endif %}</td>
            <td class="actions" role="cell">
              <div class="action-group">
                 {% if perms.myapp.view_contratocolectivo %}
                  <a href="{% url 'myapp:contrato_colectivo_detail' contrato.pk %}" class="action-icon" title="Ver Detalles" aria-label="Ver detalles del contrato {{ contrato.numero_contrato|escape }}">ğŸ‘ï¸</a>
                {% endif %}
                {% if perms.myapp.change_contratocolectivo %}
                  <a href="{% url 'myapp:contrato_colectivo_update' contrato.pk %}" class="action-icon" title="Editar" aria-label="Editar contrato {{ contrato.numero_contrato|escape }}">âœï¸</a>
                {% endif %}
                {% if perms.myapp.delete_contratocolectivo %}
                  <a href="{% url 'myapp:contrato_colectivo_delete' contrato.pk %}" class="action-icon delete-link" title="Eliminar" aria-label="Eliminar contrato {{ contrato.numero_contrato|escape }}">âŒ</a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr role="row">
            <td colspan="18" class="no-results" role="cell">
              ğŸ“­ No se encontraron contratos colectivos que coincidan con la bÃºsqueda.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if is_paginated %}
    <nav aria-label="NavegaciÃ³n de pÃ¡ginas de contratos colectivos">
      <div class="django-pagination">
        {% if page_obj.has_previous %}
          <a href="?{% query_transform page=1 %}" class="btn-pagination" aria-label="Primera pÃ¡gina">Â« Primera</a>
          <a href="?{% query_transform page=page_obj.previous_page_number %}" class="btn-pagination" aria-label="PÃ¡gina anterior">â€¹ Anterior</a>
        {% endif %}
        <span class="pagination-current">
          PÃ¡gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        </span>
        {% if page_obj.has_next %}
          <a href="?{% query_transform page=page_obj.next_page_number %}" class="btn-pagination" aria-label="Siguiente pÃ¡gina">Siguiente â€º</a>
          <a href="?{% query_transform page=page_obj.paginator.num_pages %}" class="btn-pagination" aria-label="Ãšltima pÃ¡gina">Ãšltima Â»</a>
        {% endif %}
      </div>
    </nav>
    {% endif %}

  </section>
</div>
{% endblock content %}