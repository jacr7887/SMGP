{% extends "home.html" %}
{% load static %}
{% load querystring_tags %} {# AsegÃºrate que este tag library estÃ© correctamente cargado #}
{% load humanize %}

{% block title %}Listado de Intermediarios{% endblock %}

{% block content %}
<div class="container" role="main" aria-labelledby="main-heading">
  <section>

    <h1 id="main-heading">ğŸ¤ Listado Completo de Intermediarios</h1>


    <div class="header-actions">
      {% if perms.myapp.add_intermediario %}
      <a href="{% url 'myapp:intermediario_create' %}" class="nav_link" aria-label="Crear nuevo intermediario">
        â• Nuevo Intermediario
      </a>
      {% endif %}
    </div>

    {# --- Formulario de BÃºsqueda General --- #}
    <form method="get" class="search-form mb-3" aria-label="Formulario de bÃºsqueda de intermediarios">
      <input
        type="text"
        name="q" {# Coincide con request.GET.get('search',...) en la vista #}
        placeholder="ğŸ” Buscar por Nombre, CÃ³digo, RIF, Email..."
        value="{{ search_query|escape }}" {# Usa la variable del contexto #}
        aria-label="Campo de bÃºsqueda global"
        class="search-input"
      />
      <button type="submit" class="nav_link">Buscar</button>
      <a href="{% url 'myapp:intermediario_list' %}" class="nav_link" style="margin-left: 10px;" title="Limpiar bÃºsqueda y filtros">Limpiar</a>
    </form>

    <div class="table-container" role="region" aria-labelledby="table-caption">
      <table class="data-table" role="table">
        <caption id="table-caption" class="visually-hidden">
          Lista completa de intermediarios registrados. Haga clic en las cabeceras para ordenar.
        </caption>
        <thead role="rowgroup">
          <tr role="row">
            <th class="sort-header" role="columnheader">
              <a href="?{% query_transform sort='codigo' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% if filter %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}{% endif %}">
                ğŸ”‘ CÃ³digo {% if current_sort == 'codigo' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}
              </a>
            </th>
            <th class="sort-header" role="columnheader">
              <a href="?{% query_transform sort='nombre_completo' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% if filter %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}{% endif %}">
                ğŸ‘¤ Nombre Completo {% if current_sort == 'nombre_completo' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}
              </a>
            </th>
            <th class="sort-header" role="columnheader">
              <a href="?{% query_transform sort='rif' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% if filter %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}{% endif %}">
                ğŸ†” RIF {% if current_sort == 'rif' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}
              </a>
            </th>
            <th class="sort-header" role="columnheader">
              <a href="?{% query_transform sort='email_contacto' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% if filter %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}{% endif %}">
                ğŸ“§ Email Contacto {% if current_sort == 'email_contacto' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}
              </a>
            </th>
            <th class="sort-header" role="columnheader">
              <a href="?{% query_transform sort='telefono_contacto' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% if filter %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}{% endif %}">
                ğŸ“ Tel. Contacto {% if current_sort == 'telefono_contacto' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}
              </a>
            </th>
            <th class="sort-header text-end" role="columnheader"> {# Alineado a la derecha para nÃºmeros #}
              <a href="?{% query_transform sort='porcentaje_comision' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% if filter %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}{% endif %}">
                ğŸ’² % ComisiÃ³n {% if current_sort == 'porcentaje_comision' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}
              </a>
            </th>
            {# --- NUEVA CABECERA PARA PORCENTAJE OVERRIDE --- #}
            <th class="sort-header text-end" role="columnheader"> {# Alineado a la derecha #}
              <a href="?{% query_transform sort='porcentaje_override' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% if filter %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}{% endif %}">
                ğŸ”— % Override {% if current_sort == 'porcentaje_override' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}
              </a>
            </th>
            {# --- FIN NUEVA CABECERA --- #}
            <th class="sort-header" role="columnheader">
              <a href="?{% query_transform sort='activo' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% if filter %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}{% endif %}">
                ğŸ’¡ Activo {% if current_sort == 'activo' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}
              </a>
            </th>
            <th class="sort-header" role="columnheader">
              <a href="?{% query_transform sort='direccion_fiscal' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% if filter %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}{% endif %}">
                ğŸ“ Dir. Fiscal {% if current_sort == 'direccion_fiscal' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}
              </a>
            </th>
            <th class="sort-header" role="columnheader">
              <a href="?{% query_transform sort='intermediario_relacionado__nombre_completo' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% if filter %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}{% endif %}">
                â¬†ï¸ Interm. Rel. {% if current_sort == 'intermediario_relacionado__nombre_completo' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}
              </a>
            </th>
            <th class="sort-header" role="columnheader">
              <a href="?{% query_transform sort='fecha_creacion' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% if filter %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}{% endif %}">
                â• F. CreaciÃ³n {% if current_sort == 'fecha_creacion' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}
              </a>
            </th>
            <th class="sort-header" role="columnheader">
              <a href="?{% query_transform sort='fecha_modificacion' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% if filter %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}{% endif %}">
                ğŸ”„ F. ModificaciÃ³n {% if current_sort == 'fecha_modificacion' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}
              </a>
            </th>

            <th role="columnheader">âš™ï¸ Acciones</th>
          </tr>
        </thead>
        <tbody role="rowgroup">
          {% for intermediario in object_list %}
          <tr role="row">
            <td role="cell" data-label="CÃ³digo:">{{ intermediario.codigo|escape }}</td>
            <td role="cell" data-label="Nombre Completo:">{{ intermediario.nombre_completo|escape }}</td>
            <td role="cell" data-label="RIF:">{{ intermediario.rif|escape|default:"-" }}</td>
            <td role="cell" data-label="Email Contacto:">{{ intermediario.email_contacto|escape|default:"-" }}</td>
            <td role="cell" data-label="Tel. Contacto:">{{ intermediario.telefono_contacto|escape|default:"-" }}</td>
            <td class="text-end" role="cell" data-label="% ComisiÃ³n:">{{ intermediario.porcentaje_comision|floatformat:2|default:"0.00" }}%</td>
            {# --- NUEVA CELDA PARA PORCENTAJE OVERRIDE --- #}
            <td class="text-end" role="cell" data-label="% Override:">{{ intermediario.porcentaje_override|floatformat:2|default:"0.00" }}%</td>
            {# --- FIN NUEVA CELDA --- #}
            <td role="cell" data-label="Activo:">{% if intermediario.activo %}âœ… SÃ­{% else %}ğŸ”´ No{% endif %}</td>
            <td role="cell" data-label="Dir. Fiscal:" title="{{ intermediario.direccion_fiscal|escape|default:'' }}">{{ intermediario.direccion_fiscal|escape|truncatechars:30|default:"-" }}</td>
            <td role="cell" data-label="Interm. Rel.:">
                {% if intermediario.intermediario_relacionado %}
                    <a href="{% url 'myapp:intermediario_detail' intermediario.intermediario_relacionado.pk %}" title="{{ intermediario.intermediario_relacionado.nombre_completo|escape }}">
                        {{ intermediario.intermediario_relacionado.codigo|escape }}
                    </a>
                {% else %}
                    -
                {% endif %}
            </td>
            <td role="cell" data-label="F. CreaciÃ³n:">{{ intermediario.fecha_creacion|date:"d/m/y H:i" }}</td>
            <td role="cell" data-label="F. ModificaciÃ³n:">{{ intermediario.fecha_modificacion|date:"d/m/y H:i" }}</td>

            <td class="actions" role="cell" data-label="Acciones:">
              <div class="action-group">
                 {% if perms.myapp.view_intermediario %}
                  <a href="{% url 'myapp:intermediario_detail' intermediario.pk %}" class="action-icon" title="Ver Detalles" aria-label="Ver detalles del intermediario {{ intermediario.nombre_completo|escape }}">ğŸ‘ï¸</a>
                {% endif %}
                {% if perms.myapp.change_intermediario %}
                  <a href="{% url 'myapp:intermediario_update' intermediario.pk %}" class="action-icon" title="Editar" aria-label="Editar intermediario {{ intermediario.nombre_completo|escape }}">âœï¸</a>
                {% endif %}
                {% if perms.myapp.delete_intermediario %}
                  <a href="{% url 'myapp:intermediario_delete' intermediario.pk %}" class="action-icon delete-link" title="Eliminar" aria-label="Eliminar intermediario {{ intermediario.nombre_completo|escape }}">âŒ</a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr role="row">
            <td colspan="13" class="no-results" role="cell"> {# Ajusta el colspan al nuevo nÃºmero de columnas (13 ahora) #}
               {% if search_query %}
                 ğŸ“­ No se encontraron intermediarios que coincidan con la bÃºsqueda "{{ search_query|escape }}".
               {% elif filter and filter.form.is_bound %}
                 ğŸ“­ No se encontraron intermediarios que coincidan con los filtros aplicados. <a href="{% url 'myapp:intermediario_list' %}">Limpiar filtros</a>.
               {% else %}
                 ğŸ“­ No hay intermediarios registrados todavÃ­a. {% if perms.myapp.add_intermediario %}<a href="{% url 'myapp:intermediario_create' %}">Crear uno nuevo</a>.{% endif %}
               {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if is_paginated %}
    <nav aria-label="NavegaciÃ³n de pÃ¡ginas de intermediarios">
      <div class="django-pagination">
        {% if page_obj.has_previous %}
          <a href="?{% query_transform page=1 search=search_query %}{% if filter %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}{% endif %}" class="btn-pagination" aria-label="Primera pÃ¡gina">Â« Primera</a>
          <a href="?{% query_transform page=page_obj.previous_page_number search=search_query %}{% if filter %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}{% endif %}" class="btn-pagination" aria-label="PÃ¡gina anterior">â€¹ Anterior</a>
        {% else %}
            <span class="btn-pagination disabled" aria-disabled="true">Â« Primera</span>
            <span class="btn-pagination disabled" aria-disabled="true">â€¹ Anterior</span>
        {% endif %}
        <span class="pagination-current">
          PÃ¡gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        </span>
        {% if page_obj.has_next %}
          <a href="?{% query_transform page=page_obj.next_page_number search=search_query %}{% if filter %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}{% endif %}" class="btn-pagination" aria-label="Siguiente pÃ¡gina">Siguiente â€º</a>
          <a href="?{% query_transform page=page_obj.paginator.num_pages search=search_query %}{% if filter %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}{% endif %}" class="btn-pagination" aria-label="Ãšltima pÃ¡gina">Ãšltima Â»</a>
        {% else %}
            <span class="btn-pagination disabled" aria-disabled="true">Siguiente â€º</span>
            <span class="btn-pagination disabled" aria-disabled="true">Ãšltima Â»</span>
        {% endif %}
      </div>
    </nav>
    {% endif %}
  </section>
</div>
{% endblock content %}