{% extends "home.html" %}
{% load static %}
{% load humanize %}
{% load querystring_tags %}

{% block title %}Listado de Comisiones Registradas{% endblock %}

{% block form_media_css %} {# Para el CSS de los widgets del filtro, si es necesario #}
    {{ block.super }}
    {% if filter %}{{ filter.form.media.css }}{% endif %}
{% endblock form_media_css %}

{% block extra_css %}
{{ block.super }}
<style>
  .search-form-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  .search-form-container .search-input {
    flex-grow: 1;
  }
  .search-form-container .nav_link {
    flex-shrink: 0;
  }
  /* Estilos para Select2 con tu tema oscuro (COPIA Y AJUSTA DESDE TU CSS FUNCIONAL) */
  .dark-group .select2-container .select2-selection--single,
  .dark-group .select2-container .select2-selection--multiple {
    background-color: #2a2f45 !important; 
    border: 1px solid #4b5378 !important; 
    color: #fff !important;
    border-radius: 0.25rem !important; /* O tu border-radius */
    min-height: 38px; /* Ajusta a la altura de tus inputs */
    padding-top: 0.1rem; 
    padding-bottom: 0.1rem;
  }
  .dark-group .select2-container--default .select2-selection--single .select2-selection__rendered {
    color: #fff !important;
    line-height: 36px !important; /* Ajusta */
  }
  .dark-group .select2-container--default .select2-selection--single .select2-selection__arrow b {
    border-color: #fff transparent transparent transparent !important;
  }
  /* Estilos para el desplegable de Select2 */
  .select2-dropdown { 
    background-color: #2a2f45 !important;
    border: 1px solid #4b5378 !important;
    color: #fff !important;
  }
  .select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #4b5378 !important;
    color: #fff !important;
  }
   .select2-container--default .select2-results__option {
    color: #ccc !important;
  }
   .select2-container--default .select2-results__option[aria-selected=true] {
    background-color: #3a3f58 !important;
  }
  .select2-search--dropdown .select2-search__field {
    background-color: #1e2235 !important;
    color: #fff !important;
    border: 1px solid #4b5378 !important;
  }
  /* Para selecciones m√∫ltiples */
  .dark-group .select2-container--default .select2-selection--multiple .select2-selection__choice {
    background-color: #4b5378 !important;
    border: 1px solid #3a3f58 !important;
    color: #fff !important;
    margin-top: 4px !important; 
  }
  .dark-group .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
    color: #aaa !important;
  }
  .dark-group .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
    color: #fff !important;
  }
</style>
{% endblock %}

{% block content %}
<div class="container" role="main" aria-labelledby="main-heading">
    <section>
        <h1 id="main-heading">üí∏ Listado de Comisiones Registradas</h1>

        <div class="header-actions mb-3">
            <a href="{% url 'myapp:liquidacion_comisiones' %}" class="nav_link">üí∞ Ver Liquidaci√≥n Pendientes</a>
        </div>

        {# --- BUSCADOR SIMPLE ARRIBA DE LA TABLA --- #}
        <form method="get" action="{% url 'myapp:registro_comision_list' %}" role="search">
            <div class="search-form-container">
                <input type="text" class="search-input" name="search_query"
                       placeholder="Buscar (ID, Intermediario, Factura, N¬∞ Recibo...)" 
                       value="{{ search_query|default:'' }}"
                       aria-label="Buscar comisiones">
                
                {% for key, value_list in request.GET.lists %}
                    {% if key != "search_query" and key != "page" %}
                        {% for value in value_list %}
                            <input type="hidden" name="{{ key }}" value="{{ value }}">
                        {% endfor %}
                    {% endif %}
                {% endfor %}
                <button type="submit" class="nav_link">üîç Buscar</button>
                <a href="{% url 'myapp:registro_comision_list' %}" class="nav_link" title="Limpiar b√∫squeda y filtros">üßπ Limpiar Todo</a>
            </div>
        </form>
        
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show compact-form" role="alert" style="margin-bottom: 1rem;">
                    {{ message|escape }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                </div>
            {% endfor %}
        {% endif %}

        <div class="table-container" role="region" aria-labelledby="table-caption-comisiones">
            <table class="data-table" role="table">
                <caption id="table-caption-comisiones" class="visually-hidden">Tabla de Registros de Comisiones</caption>
                <thead>
                    <tr role="row">
                        <th class="sort-header" scope="col"><a href="?{% query_transform sort='id' order=current_order|toggle_order:'asc' search_query=search_query page=1 %}{{ filter_params_pagination }}">üÜî ID {% if current_sort == 'id' %}<span>{% if current_order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}</span>{% endif %}</a></th>
                        <th class="sort-header" scope="col"><a href="?{% query_transform sort='intermediario__nombre_completo' order=current_order|toggle_order:'asc' search_query=search_query page=1 %}{{ filter_params_pagination }}">üë§ Benef. {% if current_sort == 'intermediario__nombre_completo' %}<span>{% if current_order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}</span>{% endif %}</a></th>
                        <th class="sort-header" scope="col"><a href="?{% query_transform sort='tipo_comision' order=current_order|toggle_order:'asc' search_query=search_query page=1 %}{{ filter_params_pagination }}">üìã Tipo {% if current_sort == 'tipo_comision' %}<span>{% if current_order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}</span>{% endif %}</a></th>
                        <th class="sort-header text-end" scope="col"><a href="?{% query_transform sort='monto_comision' order=current_order|toggle_order:'asc' search_query=search_query page=1 %}{{ filter_params_pagination }}">üí∞ Monto {% if current_sort == 'monto_comision' %}<span>{% if current_order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}</span>{% endif %}</a></th>
                        <th class="sort-header text-end" scope="col"><a href="?{% query_transform sort='monto_base_calculo' order=current_order|toggle_order:'asc' search_query=search_query page=1 %}{{ filter_params_pagination }}">üí≤ Base {% if current_sort == 'monto_base_calculo' %}<span>{% if current_order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}</span>{% endif %}</a></th>
                        <th class="sort-header text-end" scope="col"><a href="?{% query_transform sort='porcentaje_aplicado' order=current_order|toggle_order:'asc' search_query=search_query page=1 %}{{ filter_params_pagination }}">üìä % {% if current_sort == 'porcentaje_aplicado' %}<span>{% if current_order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}</span>{% endif %}</a></th>
                        <th scope="col">üßæ Factura</th>
                        <th scope="col">üí≥ P. Cliente</th>
                        <th class="sort-header" scope="col"><a href="?{% query_transform sort='intermediario_vendedor__nombre_completo' order=current_order|toggle_order:'asc' search_query=search_query page=1 %}{{ filter_params_pagination }}">üë®‚Äçüíº Vend. {% if current_sort == 'intermediario_vendedor__nombre_completo' %}<span>{% if current_order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}</span>{% endif %}</a></th>
                        <th class="sort-header" scope="col"><a href="?{% query_transform sort='estatus_pago_comision' order=current_order|toggle_order:'asc' search_query=search_query page=1 %}{{ filter_params_pagination }}">üö¶ Estado {% if current_sort == 'estatus_pago_comision' %}<span>{% if current_order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}</span>{% endif %}</a></th>
                        <th class="sort-header" scope="col"><a href="?{% query_transform sort='fecha_calculo' order=current_order|toggle_order:'asc' search_query=search_query page=1 %}{{ filter_params_pagination }}">üìÖ F. C√°lculo {% if current_sort == 'fecha_calculo' %}<span>{% if current_order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}</span>{% endif %}</a></th>
                        <th class="sort-header" scope="col"><a href="?{% query_transform sort='fecha_pago_a_intermediario' order=current_order|toggle_order:'asc' search_query=search_query page=1 %}{{ filter_params_pagination }}">üóìÔ∏è F. Pago Int. {% if current_sort == 'fecha_pago_a_intermediario' %}<span>{% if current_order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}</span>{% endif %}</a></th>
                        <th class="sort-header" scope="col"><a href="?{% query_transform sort='usuario_que_liquido__username' order=current_order|toggle_order:'asc' search_query=search_query page=1 %}{{ filter_params_pagination }}">üßë‚Äçüíª Liquid√≥ {% if current_sort == 'usuario_que_liquido__username' %}<span>{% if current_order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}</span>{% endif %}</a></th>
                        
                        {# === INICIO DE LA NUEVA COLUMNA === #}
                        <th scope="col" class="text-center">üìé Comp.</th>
                        {# === FIN DE LA NUEVA COLUMNA === #}
                        
                        <th scope="col" class="actions-header">‚öôÔ∏è Acciones</th>
                    </tr>
                </thead>
                <tbody role="rowgroup">
                    {% for comision in object_list %}
                    <tr role="row" class="{% cycle 'row1' 'row2' %}">
                        <td role="cell" data-label="ID:"><a href="{% url 'myapp:registro_comision_detail' comision.pk %}">{{ comision.pk|escape }}</a></td>
                        <td role="cell" data-label="Inter. Benef.:">{% if comision.intermediario %}<a href="{% url 'myapp:intermediario_detail' comision.intermediario.pk %}">{{ comision.intermediario.nombre_completo|truncatechars:20|default:comision.intermediario.codigo|escape }}</a>{% else %}N/A{% endif %}</td>
                        <td role="cell" data-label="Tipo:">{{ comision.get_tipo_comision_display|escape }}</td>
                        <td class="text-end" role="cell" data-label="Monto Comisi√≥n:">{{ comision.monto_comision|floatformat:2|intcomma|default:"0.00" }}</td>
                        <td class="text-end" role="cell" data-label="Base C√°lculo:">{{ comision.monto_base_calculo|floatformat:2|intcomma|default:"0.00" }}</td>
                        <td class="text-end" role="cell" data-label="% Aplic.:">{{ comision.porcentaje_aplicado|floatformat:2|default:"0.00" }}%</td>
                        <td role="cell" data-label="Factura:">{% if comision.factura_origen %}<a href="{% url 'myapp:factura_detail' comision.factura_origen.pk %}">{{ comision.factura_origen.numero_recibo|default_if_none:"Ver"|truncatechars:15|escape }}</a>{% else %}N/A{% endif %}</td>
                        <td role="cell" data-label="Pago Cliente:">{% if comision.pago_cliente %}<a href="{% url 'myapp:pago_detail' comision.pago_cliente.pk %}">{{ comision.pago_cliente.referencia_pago|default_if_none:"Ver"|truncatechars:10|escape }}</a>{% else %}N/A{% endif %}</td>
                        <td role="cell" data-label="Inter. Vendedor:">{% if comision.intermediario_vendedor %}<a href="{% url 'myapp:intermediario_detail' comision.intermediario_vendedor.pk %}">{{ comision.intermediario_vendedor.nombre_completo|truncatechars:20|default:comision.intermediario_vendedor.codigo|escape }}</a>{% else %}N/A{% endif %}</td>
                        <td role="cell" data-label="Estado Pago:"><span class="badge {% if comision.estatus_pago_comision == 'PAGADA' %}badge-success{% elif comision.estatus_pago_comision == 'PENDIENTE' %}badge-warning{% elif comision.estatus_pago_comision == 'ANULADA' %}badge-danger{% else %}badge-secondary{% endif %}">{{ comision.get_estatus_pago_comision_display|escape }}</span></td>
                        <td role="cell" data-label="Fecha C√°lculo:">{{ comision.fecha_calculo|date:"d/m/y H:i"|default:"-" }}</td>
                        <td role="cell" data-label="Fecha Pago Int.:">{{ comision.fecha_pago_a_intermediario|date:"d/m/y"|default:"-" }}</td>
                        <td role="cell" data-label="Liquid√≥:">{% if comision.usuario_que_liquido %}{{ comision.usuario_que_liquido.username|default:"N/A" }}{% else %}-{% endif %}</td>
                        
                        {# === INICIO DEL CONTENIDO DE LA NUEVA CELDA === #}
                        <td role="cell" data-label="Comprobante:" class="text-center">
                            {% if comision.comprobante_pago %}
                                <a href="{{ comision.comprobante_pago.url }}" class="file-popup-trigger action-icon" data-popup-title="Comprobante Comisi√≥n #{{ comision.pk }}">
                                    üìé
                                </a>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        {# === FIN DEL CONTENIDO DE LA NUEVA CELDA === #}
                        
                        <td class="actions" role="cell" data-label="Acciones:">
                            <div class="action-group">
                                {% if perms.myapp.view_registrocomision %}<a href="{% url 'myapp:registro_comision_detail' comision.pk %}" class="action-icon" title="Ver Detalles">üëÅÔ∏è</a>{% endif %}
                                {% if comision.estatus_pago_comision == 'PENDIENTE' and perms.myapp.change_registrocomision %}
                                <form method="post" action="{% url 'myapp:marcar_comisiones_pagadas' %}" style="display: inline;" class="action-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="comisiones_a_pagar_ids" value="{{ comision.id }}">
                                    <button type="submit" class="action-icon-btn btn-success btn-sm" title="Marcar como Pagada">‚úÖ</button>
                                </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr role="row"><td colspan="15" class="no-results" role="cell">üö´ No se encontraron registros de comisiones que coincidan con los criterios.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if is_paginated %}
        <nav aria-label="Navegaci√≥n de p√°ginas de comisiones" class="mt-4">
          <div class="django-pagination">
            <span class="pagination-step-links">
                {% if page_obj.has_previous %}
                    <a href="?{% query_transform page=1 search_query=search_query %}{{ filter_params_pagination }}{{ sort_params_pagination }}" class="btn-pagination" aria-label="Primera p√°gina">¬´ Primera</a>
                    <a href="?{% query_transform page=page_obj.previous_page_number search_query=search_query %}{{ filter_params_pagination }}{{ sort_params_pagination }}" class="btn-pagination" aria-label="P√°gina anterior">‚Äπ Anterior</a>
                {% else %}
                    <span class="btn-pagination disabled" aria-disabled="true">¬´ Primera</span>
                    <span class="btn-pagination disabled" aria-disabled="true">‚Äπ Anterior</span>
                {% endif %}
                
                <span class="pagination-current" aria-current="page">
                  P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}.
                </span>
                
                {% if page_obj.has_next %}
                    <a href="?{% query_transform page=page_obj.next_page_number search_query=search_query %}{{ filter_params_pagination }}{{ sort_params_pagination }}" class="btn-pagination" aria-label="Siguiente p√°gina">Siguiente ‚Ä∫</a>
                    <a href="?{% query_transform page=page_obj.paginator.num_pages search_query=search_query %}{{ filter_params_pagination }}{{ sort_params_pagination }}" class="btn-pagination" aria-label="√öltima p√°gina">√öltima ¬ª</a>
                {% else %}
                    <span class="btn-pagination disabled" aria-disabled="true">Siguiente ‚Ä∫</span>
                    <span class="btn-pagination disabled" aria-disabled="true">√öltima ¬ª</span>
                {% endif %}
            </span>
          </div>
        </nav>
        {% endif %}
    </section>
</div>
{% endblock content %}

{% block form_media_js %} {# Poner el JS de los widgets de filtro aqu√≠, despu√©s de jQuery y Select2.js #}
    {{ block.super }}
    {% if filter %}{{ filter.form.media.js }}{% endif %}
{% endblock form_media_js %}

{% block extra_js %}

{% endblock extra_js %}