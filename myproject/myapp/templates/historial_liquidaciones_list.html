{% extends "base.html" %}
{% load static humanize %}
{% load querystring_tags %}

{% block title %}{{ page_title|default:"Historial de Liquidaciones" }}{% endblock %}

{% block content %}
<div class="dark-container page-list-view" role="main" aria-labelledby="main-heading-historial">
  <section>
    <div class="list-header">
        <h1 id="main-heading-historial" class="main-title">{{ page_title|default:"üìú Historial de Liquidaciones de Comisiones" }}</h1>
        <div class="header-actions">
            <a href="{% url 'myapp:liquidacion_comisiones' %}" class="nav_link">
                <i class="fas fa-hand-holding-usd me-1"></i> Ir a Liquidaciones Pendientes
            </a>
             <a href="{% url 'myapp:registro_comision_list' %}" class="nav_link">
                <i class="fas fa-list-alt me-1"></i> Ver Todos los Registros (Incl. Pendientes)
            </a>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show compact-form" role="alert">
                {{ message|escape }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
            </div>
        {% endfor %}
    {% endif %}

    <form method="get" class="search-form mb-3" action="." aria-label="Formulario de b√∫squeda de liquidaciones">
      <input
        type="text"
        name="search" 
        class="search-input"
        placeholder="üîç Buscar por ID, Intermediario, Factura, Liquidador..."
        value="{{ search_query|default_if_none:'' }}"
        aria-label="T√©rmino de b√∫squeda"
      />
      <button type="submit" class="nav_link">Buscar</button>
      <a href="{% url 'myapp:historial_liquidaciones_list' %}" class="nav_link" style="margin-left: 10px;" title="Limpiar b√∫squeda">Limpiar</a>
    </form>

    <div class="table-container glass-card">
        {% if liquidaciones %}
        <table class="data-table">
            <thead>
                <tr>
                    {% for field, label in ordering_options.items %}
                    <th class="sort-header">
                        <a href="?{% query_transform sort=field order=current_order|toggle_order:'asc' search=search_query page=1 %}">
                            {{ label }} 
                            {% if current_sort == field %}
                                <span>{% if current_order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}</span>
                            {% else %}
                                <span>‚ÜïÔ∏è</span>
                            {% endif %}
                        </a>
                    </th>
                    {% endfor %}
                    <th>Factura Origen</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for liquidacion_item in liquidaciones %}
                <tr>
                    <td>{{ liquidacion_item.pk }}</td>
                    <td>
                        {% if liquidacion_item.intermediario %}
                            <a href="{% url 'myapp:intermediario_detail' liquidacion_item.intermediario.pk %}" title="{{ liquidacion_item.intermediario.nombre_completo }}">{{ liquidacion_item.intermediario.nombre_completo|truncatechars:25 }}</a>
                            ({{ liquidacion_item.intermediario.codigo }})
                        {% else %} N/A {% endif %}
                    </td>
                    <td class="text-end">{{ liquidacion_item.monto_comision|floatformat:2|intcomma }}</td>
                    <td>{{ liquidacion_item.get_tipo_comision_display }}</td>
                    <td>{{ liquidacion_item.fecha_pago_a_intermediario|date:"d/m/Y"|default:"-" }}</td>
                    <td>
                        {% if liquidacion_item.usuario_que_liquido %}
                            {{ liquidacion_item.usuario_que_liquido.get_full_name|default:liquidacion_item.usuario_que_liquido.username|default:"-" }}
                        {% else %}
                            Sistema/N.A.
                        {% endif %}
                    </td>
                    <td>
                        {% if liquidacion_item.factura_origen %}
                            <a href="{% url 'myapp:factura_detail' liquidacion_item.factura_origen.pk %}">
                                {{ liquidacion_item.factura_origen.numero_recibo|truncatechars:15 }}
                            </a>
                        {% else %} N/A {% endif %}
                    </td>
                    <td>{{ liquidacion_item.fecha_calculo|date:"d/m/y H:i"|default:"-" }}</td>
                    <td class="actions">
                        <a href="{% url 'myapp:registro_comision_detail' liquidacion_item.pk %}" class="action-icon" title="Ver Detalle Comisi√≥n">üëÅÔ∏è</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="alert alert-info mt-3">
            No hay liquidaciones de comisiones que coincidan con los criterios de b√∫squeda
            {% if search_query %} para "{{ search_query|escape }}"{% endif %}.
        </div>
        {% endif %}
    </div>
        {% if is_paginated %}
    <nav aria-label="Navegaci√≥n de p√°ginas de pagos">
      <div class="django-pagination">
        {% if page_obj.has_previous %}
          <a href="?{% query_transform page=1 %}" class="btn-pagination" aria-label="Primera p√°gina">¬´ Primera</a>
          <a href="?{% query_transform page=page_obj.previous_page_number %}" class="btn-pagination" aria-label="P√°gina anterior">‚Äπ Anterior</a>
        {% endif %}
        <span class="pagination-current">
          P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        </span>
        {% if page_obj.has_next %}
          <a href="?{% query_transform page=page_obj.next_page_number %}" class="btn-pagination" aria-label="Siguiente p√°gina">Siguiente ‚Ä∫</a>
          <a href="?{% query_transform page=page_obj.paginator.num_pages %}" class="btn-pagination" aria-label="√öltima p√°gina">√öltima ¬ª</a>
        {% endif %}
      </div>
    </nav>
    {% endif %}

  </section>
</div>
{% endblock %}

{% block extra_js %}
{# Si tienes JS espec√≠fico para esta p√°gina, como inicializar tooltips o algo as√≠ #}
{% endblock %}