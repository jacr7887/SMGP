{% extends "home.html" %}
{% load static %}
{% load humanize %}
{% load querystring_tags %} {# Mantenlo por si usas la ordenaciÃ³n #}

{% block content %}
<div class="container" role="main" aria-labelledby="main-heading">
  <section>
    <h1 id="main-heading">ğŸ“‹ Listado de AuditorÃ­a del Sistema</h1>

    {# Botones de acciÃ³n (si aplica, usualmente no para auditorÃ­a) #}
    <div class="header-actions">
        <a href="{% url 'myapp:home' %}" class="nav_link">Volver a Inicio</a>
    </div>

    {# --- Barra de BÃºsqueda Simple --- #}
    <form method="get" class="search-form mb-3" aria-label="Formulario de bÃºsqueda de auditorÃ­a">
      {# No necesitas csrf_token para GET #}
      <input
        type="text"
        name="search" {# Usar 'search' si tu vista lo espera para bÃºsqueda general #}
        placeholder="ğŸ” Buscar por Usuario, Tabla, IP, Detalle..." {# Placeholder actualizado #}
        value="{{ search_query|escape }}" {# Variable del contexto de la vista #}
        aria-label="Campo de bÃºsqueda"
        class="search-input"
      />
      <button type="submit" class="nav_link">Buscar</button>
      <a href="{% url 'myapp:auditoria_sistema_list' %}" class="nav_link" style="margin-left: 10px;" title="Limpiar bÃºsqueda">Limpiar</a>
    </form>
    {# --- FIN Barra de BÃºsqueda Simple --- #}

    {# --- SECCIÃ“N DE FILTROS DETALLADOS ELIMINADA --- #}
    {# Ya no renderizamos {{ filter.form.as_p }} ni el grid de filtros #}

    {# --- Tabla de Datos --- #}
    <div class="table-container" role="region" aria-labelledby="table-caption">
      <table class="data-table" role="table">
        <caption id="table-caption" class="visually-hidden">
          Lista completa de registros de auditorÃ­a del sistema. Haga clic en las cabeceras para ordenar.
        </caption>
        <thead role="rowgroup">
          <tr role="row">
            {# Cabeceras ordenables (como estaban antes, son correctas) #}
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='tiempo_inicio' order=current_order|toggle_order:'asc' search=search_query page=1 %}">â° Inicio {% if current_sort == 'tiempo_inicio' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='tipo_accion' order=current_order|toggle_order:'asc' search=search_query page=1 %}">ğŸ”„ Tipo AcciÃ³n {% if current_sort == 'tipo_accion' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='usuario__username' order=current_order|toggle_order:'asc' search=search_query page=1 %}">ğŸ‘¤ Usuario {% if current_sort == 'usuario__username' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='tabla_afectada' order=current_order|toggle_order:'asc' search=search_query page=1 %}">ğŸ“¦ Tabla {% if current_sort == 'tabla_afectada' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='registro_id_afectado' order=current_order|toggle_order:'asc' search=search_query page=1 %}">ğŸ”¢ ID Reg. {% if current_sort == 'registro_id_afectado' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='resultado_accion' order=current_order|toggle_order:'asc' search=search_query page=1 %}">âœ… Resultado {% if current_sort == 'resultado_accion' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='direccion_ip' order=current_order|toggle_order:'asc' search=search_query page=1 %}">ğŸŒ IP {% if current_sort == 'direccion_ip' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            <th role="columnheader">ğŸ“ Detalle</th>
            <th role="columnheader">ğŸ“± Agente</th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='tiempo_final' order=current_order|toggle_order:'asc' search=search_query page=1 %}">â³ Fin {% if current_sort == 'tiempo_final' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='control_fecha_actual' order=current_order|toggle_order:'asc' search=search_query page=1 %}">â±ï¸ Control {% if current_sort == 'control_fecha_actual' %}{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}{% else %}â†•ï¸{% endif %}</a></th>
            <th role="columnheader">âš™ï¸ Acciones</th>
          </tr>
        </thead>
        <tbody role="rowgroup">
          {% for auditoria in object_list %}
          <tr role="row">
            {# Celdas de datos (como estaban antes, son correctas) #}
            <td role="cell">{{ auditoria.tiempo_inicio|date:"d/m/y H:i:s" }}</td>
            <td role="cell">{{ auditoria.get_tipo_accion_display|default:auditoria.tipo_accion }}</td>
            <td role="cell">{{ auditoria.usuario.get_full_name|default:auditoria.usuario.username|default:"Sistema" }}</td>
            <td role="cell">{{ auditoria.tabla_afectada|default:"-" }}</td>
            <td role="cell">{{ auditoria.registro_id_afectado|default:"-" }}</td>
            <td role="cell">
              <span class="badge {% if auditoria.resultado_accion == 'EXITO' %}badge-success{% elif auditoria.resultado_accion == 'ERROR' %}badge-danger{% else %}badge-secondary{% endif %}">
                {{ auditoria.get_resultado_accion_display|default:auditoria.resultado_accion }}
              </span>
            </td>
            <td role="cell">{{ auditoria.direccion_ip|default:"-" }}</td>
            <td role="cell" title="{{ auditoria.detalle_accion|escape|default:'' }}">{{ auditoria.detalle_accion|escape|truncatechars:50|default:"-" }}</td>
            <td role="cell" title="{{ auditoria.agente_usuario|escape|default:'' }}">{{ auditoria.agente_usuario|escape|truncatechars:30|default:"-" }}</td>
            <td role="cell">{{ auditoria.tiempo_final|date:"d/m/y H:i:s"|default:"-" }}</td>
            <td role="cell">{{ auditoria.control_fecha_actual|date:"d/m/y H:i:s" }}</td>

            <td class="actions" role="cell">
              <div class="action-group">
                {% if perms.myapp.view_auditoriasistema %}
                <a href="{% url 'myapp:auditoria_sistema_detail' auditoria.pk %}"
                   class="action-icon"
                   aria-label="Ver detalles de la auditorÃ­a {{ auditoria.pk }}">
                  ğŸ‘ï¸
                </a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr role="row">
            <td colspan="12" class="no-results" role="cell"> {# Ajustado colspan #}
              ğŸ“­ No se encontraron registros de auditorÃ­a que coincidan con la bÃºsqueda.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {# --- PaginaciÃ³n (Usa query_transform para mantener bÃºsqueda simple) --- #}
    {% if is_paginated %}
    <nav aria-label="NavegaciÃ³n de pÃ¡ginas de auditorÃ­a">
      <div class="django-pagination">
        {% if page_obj.has_previous %}
          <a href="?{% query_transform page=1 search=search_query %}" class="btn-pagination" aria-label="Primera pÃ¡gina">Â« Primera</a>
          <a href="?{% query_transform page=page_obj.previous_page_number search=search_query %}" class="btn-pagination" aria-label="PÃ¡gina anterior">â€¹ Anterior</a>
        {% endif %}
        <span class="pagination-current">
          PÃ¡gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        </span>
        {% if page_obj.has_next %}
          <a href="?{% query_transform page=page_obj.next_page_number search=search_query %}" class="btn-pagination" aria-label="Siguiente pÃ¡gina">Siguiente â€º</a>
          <a href="?{% query_transform page=page_obj.paginator.num_pages search=search_query %}" class="btn-pagination" aria-label="Ãšltima pÃ¡gina">Ãšltima Â»</a>
        {% endif %}
      </div>
    </nav>
    {% endif %}

  </section>
</div>

{% endblock content %}