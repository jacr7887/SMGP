{% extends "home.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container" role="main" aria-labelledby="main-heading">
  <section>
    <h1 id="main-heading">ğŸ‘¤ Perfil de Usuario: {{ usuario_detalle.get_full_name|default:usuario_detalle.username|escape }}</h1>

    {# --- Botones de AcciÃ³n --- #}
    <div class="detail-actions-container mb-4">
      {% comment %} Comprobar si el usuario viendo el perfil es el mismo que el usuario logueado O si tiene permiso para cambiar CUALQUIER usuario {% endcomment %}
      {% if request.user.pk == usuario_detalle.pk or perms.myapp.change_usuario %} {# Comparar por pk es mÃ¡s seguro #}
        <a href="{% url 'myapp:usuario_update' usuario_detalle.pk %}" class="btn btn-success" aria-label="Editar este perfil">
          âœï¸ Editar Perfil
        </a>
      {% endif %}
       {# Solo mostrar Eliminar si NO es el usuario mismo Y tiene permiso #}
      {% if perms.myapp.delete_usuario and request.user.pk != usuario_detalle.pk %}
        <a href="{% url 'myapp:usuario_delete' usuario_detalle.pk %}" class="btn btn-danger delete-link" aria-label="Eliminar este usuario">
          âŒ Eliminar Usuario
        </a>
      {% endif %}
      {# BotÃ³n Volver siempre visible si se accede desde la lista #}
      {% if perms.myapp.view_usuario %}
       <a href="{% url 'myapp:usuario_list' %}" class="nav_link" aria-label="Volver al listado de usuarios">
        â¬…ï¸ Volver al Listado de Usuarios
      </a>
      {% endif %}
       <a href="{% url 'myapp:home' %}" class="nav_link" aria-label="Volver al inicio">
        ğŸ  Volver a Inicio
      </a>
    </div>

    {# --- Detalles del Usuario Agrupados --- #}
    <div class="form-main-container"> {# Asumiendo que esta clase existe #}

      {# --- InformaciÃ³n Personal --- #}
      <fieldset class="mb-4"> {# Asumiendo que esta clase existe #}
        <legend>ğŸ‘¤ InformaciÃ³n Personal</legend>
        <div class="dark-grid"> {# Asumiendo que esta clase existe #}
            <div class="dark-group">
                <span class="dark-label">ğŸ‘¤ Nombre de Usuario:</span>
                <span>{{ usuario_detalle.username|escape }}</span>
            </div>
            <div class="dark-group">
                <span class="dark-label">ğŸ“§ Correo ElectrÃ³nico:</span>
                <span>{{ usuario_detalle.email|escape }}</span>
            </div>
            <div class="dark-group">
                <span class="dark-label">ğŸ“› Primer Nombre:</span>
                <span>{{ usuario_detalle.primer_nombre|escape }}</span>
            </div>
            <div class="dark-group">
                <span class="dark-label">ğŸ“› Segundo Nombre:</span>
                <span>{{ usuario_detalle.segundo_nombre|escape|default:"-" }}</span>
            </div>
            <div class="dark-group">
                <span class="dark-label">ğŸ“› Primer Apellido:</span>
                <span>{{ usuario_detalle.primer_apellido|escape }}</span>
            </div>
            <div class="dark-group">
                <span class="dark-label">ğŸ“› Segundo Apellido:</span>
                <span>{{ usuario_detalle.segundo_apellido|escape|default:"-" }}</span>
            </div>
            <div class="dark-group">
                <span class="dark-label">ğŸ—£ï¸ Nombre Completo:</span>
                <span>{{ usuario_detalle.get_full_name|escape }}</span>
            </div>
             <div class="dark-group">
                <span class="dark-label">ğŸ“… Fecha Nacimiento:</span>
                <span>{{ usuario_detalle.fecha_nacimiento|date:"d/m/Y"|default:"No especificada" }}</span>
            </div>
            <div class="dark-group">
                <span class="dark-label">ğŸ“ TelÃ©fono:</span>
                <span>{{ usuario_detalle.telefono|escape|default:"-" }}</span>
            </div>
             <div class="dark-group" style="grid-column: span 2;">
                <span class="dark-label">ğŸ  DirecciÃ³n:</span>
                <p style="margin:0;">{{ usuario_detalle.direccion|escape|linebreaksbr|default:"-" }}</p>
            </div>
        </div>
      </fieldset>

      {# --- InformaciÃ³n de Cuenta y Roles --- #}
      <fieldset class="mb-4">
        <legend>ğŸ”‘ Cuenta y Roles</legend>
         <div class="dark-grid">
            <div class="dark-group">
                <span class="dark-label">ğŸ’¡ Estado Cuenta (SMGP):</span>
                 {# Usar tu campo 'activo' para el estado de soft delete #}
                 <span class="badge {% if usuario_detalle.activo %}badge-success{% else %}badge-danger{% endif %}">
                     {{ usuario_detalle.activo|yesno:"Activa,Inactiva (Soft Delete)" }}
                 </span>
            </div>
            <div class="dark-group">
                <span class="dark-label">ğŸ’¡ Estado Cuenta (Django):</span>
                 <span class="badge {% if usuario_detalle.is_active %}badge-success{% else %}badge-danger{% endif %}">
                     {{ usuario_detalle.is_active|yesno:"Activa,Inactiva" }}
                 </span>
            </div>
            <div class="dark-group">
                <span class="dark-label">ğŸ·ï¸ Tipo de Usuario:</span>
                {# Usar el display del contexto que ya calculaste en la vista #}
                <span>{{ tipo_usuario_display|escape|default:"N/A" }}</span>
            </div>
            <div class="dark-group">
                <span class="dark-label">ğŸ“Š Nivel de Acceso:</span>
                {# Usar el display del contexto #}
                <span>{{ nivel_acceso_display|escape }} ({{ usuario_detalle.nivel_acceso }})</span>
            </div>
            <div class="dark-group">
                <span class="dark-label">ğŸ¢ Departamento:</span>
                {# Usar el display del contexto #}
                <span>{{ departamento_display|escape|default:"No asignado" }}</span>
            </div>
            <div class="dark-group">
                 <span class="dark-label">ğŸ¤ Intermediario Asociado:</span>
                 <span>
                 {% if usuario_detalle.intermediario %}
                     {% if perms.myapp.view_intermediario %}
                     <a href="{% url 'myapp:intermediario_detail' usuario_detalle.intermediario.pk %}">{{ usuario_detalle.intermediario.nombre_completo|escape }}</a>
                     {% else %}
                     {{ usuario_detalle.intermediario.nombre_completo|escape }}
                     {% endif %}
                 {% else %}
                     No Asociado
                 {% endif %}
                 </span>
             </div>
             <div class="dark-group">
                <span class="dark-label">ğŸ§‘â€ğŸ’¼ Es Staff?:</span>
                <span>{{ usuario_detalle.is_staff|yesno:"SÃ­,No" }}</span>
            </div>
             <div class="dark-group">
                <span class="dark-label">ğŸ‘‘ Es Superusuario?:</span>
                <span>{{ usuario_detalle.is_superuser|yesno:"SÃ­,No" }}</span>
            </div>
        </div>
      </fieldset>

      {# --- Fechas de Sistema --- #}
      <fieldset class="mb-4"> {# AÃ±adido mb-4 para consistencia #}
        <legend>ğŸ—“ï¸ Fechas del Sistema</legend>
        <div class="dark-grid">
             <div class="dark-group">
               <span class="dark-label">â• Fecha de Registro:</span>
               <span>{{ usuario_detalle.date_joined|date:"d/m/Y H:i:s" }}</span>
             </div>
             <div class="dark-group">
               <span class="dark-label">ğŸšª Ãšltimo Inicio de SesiÃ³n:</span>
               <span>{{ usuario_detalle.last_login|date:"d/m/Y H:i:s"|default:"Nunca" }}</span>
             </div>
             <div class="dark-group">
                <span class="dark-label">ğŸ”„ Ãšltima ModificaciÃ³n:</span>
                <span>{{ usuario_detalle.fecha_modificacion|date:"d/m/Y H:i:s" }}</span>
              </div>
        </div>
      </fieldset>

       {% if perms.auth.view_group or perms.auth.view_permission %}
       <fieldset class="mt-4"> {# Asumiendo que esta clase existe #}
           <legend>ğŸ›¡ï¸ Grupos y Permisos Asignados</legend>
            <div class="dark-grid">
                 {% if perms.auth.view_group %}
                <div class="dark-group">
                    <span class="dark-label">Grupos:</span>
                    {# Iterar para mostrar como lista si son muchos #}
                    {% if usuario_detalle.groups.all %}
                        <ul>
                        {% for group in usuario_detalle.groups.all %}
                            <li>{{ group.name|escape }}</li>
                        {% endfor %}
                        </ul>
                    {% else %}
                        Ninguno
                    {% endif %}
                </div>
                 {% endif %}
            </div>
       </fieldset>
       {% endif %}
    </div>
  </section>
</div>
{% endblock content %}