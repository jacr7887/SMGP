{% extends "home.html" %}
{% load static %}
{% load humanize %}
{# {% load querystring_tags %} #} {# Comentado si no se usa globalmente #}

{% block title %}Detalle Contrato: {{ contrato.numero_contrato|default:"(Sin número)" }}{% endblock %}

{% block content %}
<div class="dark-container" role="main" aria-labelledby="main-heading">
  <section>
    <h1 id="main-heading">📑 Detalle del Contrato Individual: {{ contrato.numero_contrato|default:"(Sin número)" }}</h1>

    <div class="detail-actions-container mb-4">
      {% if perms.myapp.change_contratoindividual %}
        <a href="{% url 'myapp:contrato_individual_update' contrato.pk %}" class="btn btn-success" aria-label="Editar este contrato">✏️ Editar</a>
      {% endif %}
      {% if perms.myapp.delete_contratoindividual %}
        <a href="{% url 'myapp:contrato_individual_delete' contrato.pk %}" class="btn btn-danger delete-link" aria-label="Eliminar este contrato">❌ Eliminar</a>
      {% endif %}
      <a href="{% url 'myapp:contrato_individual_list' %}" class="nav_link" aria-label="Volver al listado">⬅️ Volver al Listado</a>
    </div>

    <div class="form-main-container">

      <fieldset class="mb-4">
        <legend>📄 Información Principal del Contrato</legend>
        <div class="dark-grid">
            <div class="dark-group"><span class="dark-label">📄 N° Contrato:</span><span>{{ contrato.numero_contrato|escape|default:"-" }}</span></div>
            <div class="dark-group"><span class="dark-label">#️⃣ N° Póliza:</span><span>{{ contrato.numero_poliza|escape|default:"-" }}</span></div>
            <div class="dark-group"><span class="dark-label">🌿 Ramo:</span><span>{{ contrato.get_ramo_display|escape }}</span></div>
            <div class="dark-group"><span class="dark-label">📋 Plan Contratado:</span><span>{{ contrato.plan_contratado|escape|default:"-" }}</span></div>
            <div class="dark-group"><span class="dark-label">📜 Certificado:</span><span>{{ contrato.certificado|escape|default:"-" }}</span></div>
            <div class="dark-group"><span class="dark-label">🚦 Estatus Vigencia:</span><span class="badge {% if contrato.estatus == 'VIGENTE' %}badge-success{% elif contrato.estatus == 'VENCIDO' %}badge-danger{% else %}badge-warning{% endif %}">{{ contrato.get_estatus_display|escape }}</span></div>
            <div class="dark-group"><span class="dark-label">📊 Estado Admin.:</span><span>{{ contrato.get_estado_contrato_display|escape|default:"-" }}</span></div>
            <div class="dark-group"><span class="dark-label">📝 Nota Interna:</span><span>{{ contrato.estatus_detalle|escape|default:"-" }}</span></div>
            <div class="dark-group"><span class="dark-label">💡 Activo (Sistema):</span><span class="badge {% if contrato.activo %}badge-success{% else %}badge-danger{% endif %}">{{ contrato.activo|yesno:"Sí,No" }}</span></div>
            <div class="dark-group">
                <span class="dark-label">🏷️ Tarifa Aplicada:</span>
                 <span>
                    {% if tarifa_aplicada_obj %} {# Usar la variable del contexto #}
                        {% if perms.myapp.view_tarifa %}
                            <a href="{% url 'myapp:tarifa_detail' tarifa_aplicada_obj.pk %}" title="Ver detalle tarifa">{{ tarifa_aplicada_obj }}</a>
                        {% else %}
                            {{ tarifa_aplicada_obj }}
                        {% endif %}
                    {% else %}
                        <span class="text-muted">N/A</span>
                    {% endif %}
                 </span>
            </div>
        </div>
      </fieldset>

       <fieldset class="mb-4">
        <legend>👤 Información del Afiliado y Contratante</legend>
        <div class="dark-grid">
             <div class="dark-group">
                <span class="dark-label">👤 Afiliado Principal:</span>
                 <span>
                 {% if afiliado %} {# Usar la variable del contexto #}
                     {% if user_perms.can_view_afiliados_ind %} {# Usar user_perms del contexto #}
                     <a href="{% url 'myapp:afiliado_individual_detail' afiliado.pk %}">{{ afiliado.nombre_completo|escape }} (C.I: {{ afiliado.cedula }})</a>
                     {% else %}
                     {{ afiliado.nombre_completo|escape }} (C.I: {{ afiliado.cedula }})
                     {% endif %}
                 {% else %}
                     <span class="text-muted">No asignado</span>
                 {% endif %}
                 </span>
             </div>
             <div class="dark-group"><span class="dark-label">🧑‍💼 Nombre Contratante:</span><span>{{ contrato.contratante_nombre|escape|default:"-" }}</span></div>
             <div class="dark-group"><span class="dark-label">🆔 Cédula/RIF Contratante:</span><span>{{ contrato.contratante_cedula|escape|default:"-" }}</span></div>
            <div class="dark-group"><span class="dark-label">🔖 Tipo ID Contratante:</span><span>{{ contrato.get_tipo_identificacion_contratante_display|escape|default:"-" }}</span></div>
            <div class="dark-group"><span class="dark-label">📞 Teléfono Contratante:</span><span>{{ contrato.telefono_contratante|escape|default:"-" }}</span></div>
             <div class="dark-group"><span class="dark-label">📧 Email Contratante:</span><span>{{ contrato.email_contratante|urlize|default:"-" }}</span></div>
             <div class="dark-group" style="grid-column: span 2;"><span class="dark-label">🏠 Dirección Contratante:</span><p style="margin:0;">{{ contrato.direccion_contratante|escape|linebreaksbr|default:"-" }}</p></div>
        </div>
      </fieldset>

      <fieldset class="mb-4">
        <legend>📅 Vigencia y Fechas</legend>
        <div class="dark-grid">
            <div class="dark-group"><span class="dark-label">📅 Fecha Emisión:</span><span>{{ contrato.fecha_emision|date:"d/m/Y H:i:s" }}</span></div>
            <div class="dark-group"><span class="dark-label">➡️ Inicio Vigencia Contrato:</span><span>{{ contrato.fecha_inicio_vigencia|date:"d/m/Y" }}</span></div>
            <div class="dark-group"><span class="dark-label">⏹️ Fin Vigencia Contrato:</span><span>{{ contrato.fecha_fin_vigencia|date:"d/m/Y" }}</span></div>
            <div class="dark-group"><span class="dark-label">⏱️ Duración Contrato (Meses):</span><span>{{ duracion_contrato_meses|default:contrato.periodo_vigencia_meses|default:contrato.duracion_calculada_meses|default:"-" }}</span></div>
            
            <!-- NUEVAS PROPIEDADES INTEGRADAS -->
            <div class="dark-group"><span class="dark-label">⏳ Días Vigencia Transcurridos:</span><span>{{ contrato.dias_vigencia_transcurridos|default:"0" }} días</span></div>
            <div class="dark-group"><span class="dark-label">🗓️ Días Vigencia Restantes:</span><span>{{ contrato.dias_vigencia_restantes|default:"0" }} días</span></div>
            <div class="dark-group"><span class="dark-label">🔔 Renovación Pronta (<60d):</span><span class="badge {% if contrato.necesita_renovacion_pronto %}badge-warning{% else %}badge-info{% endif %}">{{ contrato.necesita_renovacion_pronto|yesno:"Sí,No" }}</span></div>
            <!-- FIN NUEVAS PROPIEDADES -->

            <div class="dark-group"><span class="dark-label">▶️ Inicio Vigencia Recibo:</span><span>{{ contrato.fecha_inicio_vigencia_recibo|date:"d/m/Y"|default:"-" }}</span></div>
            <div class="dark-group"><span class="dark-label">⏹️ Fin Vigencia Recibo:</span><span>{{ contrato.fecha_fin_vigencia_recibo|date:"d/m/Y"|default:"-" }}</span></div>

            <div class="dark-group">
                <span class="dark-label">🗓️ Antigüedad Afiliado (en emisión):</span>
                <span>{{ dias_desde_ingreso_afiliado|default_if_none:"N/A" }} días</span>
            </div>
            <div class="dark-group"><span class="dark-label">✅ Vigente Ahora?:</span><span class="badge {% if esta_vigente_contrato %}badge-success{% else %}badge-secondary{% endif %}">{{ esta_vigente_contrato|yesno:"Sí,No" }}</span></div>
        </div>
      </fieldset>

      <fieldset class="mb-4">
        <legend>💰 Montos, Pagos y Comisiones</legend>
        <div class="dark-grid">
            <div class="dark-group"><span class="dark-label">💰 Prima Total Histórica:</span><span>${{ monto_total_contrato|floatformat:2|intcomma|default:"0.00" }}</span></div>
            <div class="dark-group"><span class="dark-label">📅 Importe Anual (Ref.):</span><span>${{ importe_anual_referencial|floatformat:2|intcomma|default:"-" }}</span></div>
            <div class="dark-group">
                <span class="dark-label">🔢 Cantidad Cuotas:</span>
                <span>{{ cantidad_cuotas_calculada|default_if_none:"-" }}</span>
            </div>
            <div class="dark-group">
                <span class="dark-label">💲 Importe Cuota:</span>
                <span>${{ importe_recibo_calculado|floatformat:2|intcomma|default:"-" }}</span>
            </div>
            <div class="dark-group"><span class="dark-label">💳 Forma Pago:</span><span>{{ forma_pago_display|escape }}</span></div>
            <div class="dark-group"><span class="dark-label">✅ Pagos Realizados (Contador):</span><span>{{ contrato.pagos_realizados|default:"0" }}</span></div>
            <div class="dark-group"><span class="dark-label">🧾 Estatus Emisión Recibo:</span><span>{{ estatus_emision_recibo_display|escape|default:"-" }}</span></div>
            <div class="dark-group"><span class="dark-label">📈 Comisión Anual (%):</span><span>{{ contrato.comision_anual|floatformat:2|default:"-" }}%</span></div>
            
            <div class="dark-group"><span class="dark-label">💸 Comisión Intermediario (Estimada):</span><span>${{ contrato.monto_comision_intermediario_estimada|floatformat:2|intcomma|default:"-" }}</span></div>

            <div class="dark-group"><span class="dark-label">🛡️ Suma Asegurada / Cobertura:</span><span>${{ suma_asegurada_contrato|floatformat:2|intcomma|default:"0.00" }}</span></div>
            
            <div class="dark-group" style="grid-column: span 2;"><span class="dark-label">💳 Estado General de Pagos:</span><span><strong>{{ contrato.estado_pago_general }}</strong></span></div>
        </div>

        <div style="grid-column: 1 / -1; border-top: 1px dashed var(--border-light); padding-top: 1rem; margin-top: 1rem;">
             <h5 style="margin-bottom: 0.8rem; text-align: center; color: var(--text-muted);">Resumen Financiero Anual (Estimado)</h5>
             <div class="dark-grid">
                  <div class="dark-group"><span class="dark-label">🗓️ Prima Anual Estimada:</span><span class="text-info"><strong>${{ prima_anual_contrato|floatformat:2|intcomma|default:"0.00" }}</strong></span></div>
                  <div class="dark-group"><span class="dark-label">✅ Total Pagado (a Facturas):</span><span class="text-success"><strong>${{ monto_total_pagado_facturas|floatformat:2|intcomma|default:"0.00" }}</strong></span></div>
                  <div class="dark-group"><span class="dark-label">⏳ Saldo Pendiente (Anual Estimado):</span><span class="text-warning"><strong>${{ saldo_pendiente_anual|floatformat:2|intcomma|default:"0.00" }}</strong></span></div>
             </div>
        </div>
      </fieldset>

      <h4 class="mt-3">💸 Pagos Realizados por Reclamaciones ({{ total_pagos_reclamaciones }})</h4>
{% if pagos_de_reclamaciones %}
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID Pago</th>
                    <th>Referencia</th>
                    <th>Fecha Pago</th>
                    <th class="text-end">Monto Pagado</th>
                    <th>Reclamo ID Asociado</th>
                    <th>Forma de Pago</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for pago_rec in pagos_de_reclamaciones %}
                <tr>
                    <td>{{ pago_rec.pk }}</td>
                    <td>{{ pago_rec.referencia_pago|default:"-" }}</td>
                    <td>{{ pago_rec.fecha_pago|date:"d/m/Y"|default:"-" }}</td>
                    <td class="text-end">${{ pago_rec.monto_pago|default:"0.00"|floatformat:2|intcomma }}</td>
                    <td>
                        {% if pago_rec.reclamacion_id %}
                            {% if user_perms.can_view_reclamaciones %} {# Asumiendo que tienes user_perms en contexto #}
                                <a href="{% url 'myapp:reclamacion_detail' pago_rec.reclamacion_id %}">#{{ pago_rec.reclamacion_id }}</a>
                            {% else %}
                                #{{ pago_rec.reclamacion_id }}
                            {% endif %}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td>{{ pago_rec.get_forma_pago_display|default:"-" }}</td>
                    <td class="actions">
                        <div class="action-group">
                            {% if user_perms.can_view_pagos %} {# Asumiendo que tienes user_perms en contexto #}
                                <a href="{% url 'myapp:pago_detail' pago_rec.pk %}" class="action-icon" title="Ver Detalle del Pago">👁️</a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            {% if monto_total_pagado_reclamaciones > 0 %}
            <tfoot>
                <tr>
                    <td colspan="3" class="text-end"><strong>Total Pagado por Reclamaciones:</strong></td>
                    <td class="text-end"><strong>${{ monto_total_pagado_reclamaciones|floatformat:2|intcomma }}</strong></td>
                    <td colspan="3"></td>
                </tr>
            </tfoot>
            {% endif %}
        </table>
    </div>
{% else %}
    <p>No hay pagos asociados a reclamaciones para este contrato.</p>
{% endif %}

      <fieldset class="mb-4">
        <legend>⚙️ Otros Datos y Sistema</legend>
        <div class="dark-grid">
            <div class="dark-group">
                <span class="dark-label">🤝 Intermediario:</span>
                <span>
                 {% if intermediario %}
                     {% if user_perms.can_view_intermediarios %}
                     <a href="{% url 'myapp:intermediario_detail' intermediario.pk %}">{{ intermediario.nombre_completo|default:intermediario.codigo|escape }}</a>
                     {% else %}
                     {{ intermediario.nombre_completo|default:intermediario.codigo|escape }}
                     {% endif %}
                 {% else %}
                     <span class="text-muted">No asignado</span>
                 {% endif %}
                 </span>
            </div>
            <div class="dark-group"><span class="dark-label">🔍 Criterio Búsqueda:</span><p style="margin:0;">{{ contrato.criterio_busqueda|escape|linebreaksbr|default:"-" }}</p></div>
            <div class="dark-group"><span class="dark-label">❓ Consultar Afiliados Activos Data:</span><span class="badge {% if contrato.consultar_afiliados_activos %}badge-info{% else %}badge-secondary{% endif %}">{{ contrato.consultar_afiliados_activos|yesno:"Sí,No" }}</span></div>
             <div class="dark-group"><span class="dark-label">➕ Fecha Creación:</span><span>{{ contrato.fecha_creacion|date:"d/m/Y H:i:s" }}</span></div>
             <div class="dark-group"><span class="dark-label">🔄 Fecha Modificación:</span><span>{{ contrato.fecha_modificacion|date:"d/m/Y H:i:s" }}</span></div>
             <div class="dark-group" style="grid-column: span 2;">
                <span class="dark-label">📜 Historial Cambios (JSON):</span>
                <pre id="historial-display-{{ contrato.pk }}" style="background-color: #2d2d2d; color: #ccc; padding: 0.5rem; border-radius: 4px; font-size: 0.85em; max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-break: break-all;">Cargando...</pre>
            </div>
        </div>
      </fieldset>
    </div>

    <div class="form-main-container mt-4">
        <fieldset>
            <legend>🔗 Relaciones Asociadas</legend>
<fieldset class="mb-4">
                 <legend>🛡️ Consumo de Cobertura</legend>
                 <div class="dark-grid">
                      <div class="dark-group"><span class="dark-label">💰 Suma Asegurada Total:</span><span class="h5">${{ object.suma_asegurada|default:"0.00"|floatformat:2|intcomma }}</span></div>
                     <div class="dark-group"><span class="dark-label">📉 Monto Total Pagado por Reclamaciones:</span><span class="h5 text-warning">${{ object.monto_total_pagado_reclamaciones|default:"0.00"|floatformat:2|intcomma }}</span></div>
                     <div class="dark-group"><span class="dark-label">✅ Saldo Disponible Cobertura:</span><span class="h5 text-success">${{ object.saldo_disponible_cobertura|default:"0.00"|floatformat:2|intcomma }}</span></div>
                      <div class="dark-group">
                         <span class="dark-label">📊 Porcentaje Consumido:</span>
                         <div class="progress" style="height: 20px; background-color: var(--glass-bg);">
                             <div class="progress-bar {% if object.porcentaje_cobertura_consumido > 80 %}bg-danger{% elif object.porcentaje_cobertura_consumido > 50 %}bg-warning{% else %}bg-success{% endif %}"
                                  role="progressbar" style="width: {{ object.porcentaje_cobertura_consumido|floatformat:0 }}%;"
                                  aria-valuenow="{{ object.porcentaje_cobertura_consumido|floatformat:1 }}" aria-valuemin="0" aria-valuemax="100">
                                  {{ object.porcentaje_cobertura_consumido|floatformat:1 }}%
                             </div>
                         </div>
                     </div>
                 </div>
             </fieldset>
            <fieldset class="mb-4">
                            <legend>🛡️ Consumo de Cobertura</legend>
                            <div class="dark-grid">
                                <div class="dark-group"><span class="dark-label">💰 Suma Asegurada Total:</span><span class="h5">${{ contrato.suma_asegurada|default:"0.00"|floatformat:2|intcomma }}</span></div>
                                <div class="dark-group"><span class="dark-label">📉 Monto Total Pagado por Reclamaciones:</span><span class="h5 text-warning">${{ contrato.monto_total_pagado_reclamaciones|default:"0.00"|floatformat:2|intcomma }}</span></div>
                                <div class="dark-group"><span class="dark-label">✅ Saldo Disponible Cobertura:</span><span class="h5 text-success">${{ contrato.saldo_disponible_cobertura|default:"0.00"|floatformat:2|intcomma }}</span></div>
                                <div class="dark-group">
                                    <span class="dark-label">📊 Porcentaje Consumido:</span>
                                    <div class="progress" style="height: 20px; background-color: var(--glass-bg);">
                                        <div class="progress-bar {% if contrato.porcentaje_cobertura_consumido > 80 %}bg-danger{% elif contrato.porcentaje_cobertura_consumido > 50 %}bg-warning{% else %}bg-success{% endif %}"
                                            role="progressbar" style="width: {{ contrato.porcentaje_cobertura_consumido|floatformat:0 }}%;"
                                            aria-valuenow="{{ contrato.porcentaje_cobertura_consumido|floatformat:1 }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ contrato.porcentaje_cobertura_consumido|floatformat:1 }}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
            <h4 class="mt-3">🆘 Reclamaciones Asociadas ({{ total_reclamaciones }})</h4>
            {% if reclamaciones_asociadas %}
               <div class="table-container">
                   <table class="data-table">
                       <thead><tr><th>ID Reclamo</th><th>Fecha Reclamo</th><th>Tipo</th><th>Estado</th><th class="text-end">Monto Reclamado</th><th>Acciones</th></tr></thead>
                       <tbody>
                           {% for rec in reclamaciones_asociadas %}
                           <tr>
                               <td>{{ rec.pk }}</td>
                               <td>{{ rec.fecha_reclamo|date:"d/m/Y"|default:"-" }}</td>
                               <td>{{ rec.get_tipo_reclamacion_display|default:"-" }}</td>
                               <td><span class="badge {% if rec.estado == 'APROBADA' or rec.estado == 'PAGADA' %}badge-success{% elif rec.estado == 'RECHAZADA' %}badge-danger{% elif rec.estado == 'EN_PROCESO' %}badge-info{% else %}badge-secondary{% endif %}">{{ rec.get_estado_display|default:rec.estado|default:"-" }}</span></td>
                               <td class="text-end">${{ rec.monto_reclamado|default:"0.00"|floatformat:2|intcomma }}</td>
                               <td class="actions"><div class="action-group">
                                  {% if user_perms.can_view_reclamaciones %}<a href="{% url 'myapp:reclamacion_detail' rec.pk %}" class="action-icon" title="Ver Reclamación">👁️</a>{% endif %}
                               </div></td>
                           </tr>
                           {% endfor %}
                       </tbody>
                   </table>
               </div>
           {% else %}
                <p>No hay reclamaciones asociadas a este contrato.</p>
           {% endif %}

           <h4 class="mt-3">💵 Facturas Asociadas ({{ total_facturas }})</h4>
           {% if facturas_asociadas %}
              <div class="table-container">
                  <table class="data-table">
                      <thead><tr><th>N° Recibo</th><th>Vigencia</th><th class="text-end">Monto (Cuota)</th><th class="text-end">Pendiente</th><th>Pagada</th><th>Acciones</th></tr></thead>
                      <tbody>
                          {% for fac in facturas_asociadas %}
                          <tr>
                              <td>{{ fac.numero_recibo }}</td>
                              <td>{{ fac.vigencia_recibo_desde|date:"d/m/y" }} - {{ fac.vigencia_recibo_hasta|date:"d/m/y" }}</td>
                              <td class="text-end">${{ fac.monto|default:"0.00"|floatformat:2|intcomma }}</td>
                              <td class="text-end"><strong class="{% if fac.monto_pendiente > 0 %}text-warning{% else %}text-success{% endif %}">${{ fac.monto_pendiente|default:"0.00"|floatformat:2|intcomma }}</strong></td>
                              <td><span class="badge {% if fac.pagada %}badge-success{% else %}badge-warning{% endif %}">{{ fac.pagada|yesno:"Sí,No" }}</span></td>
                              <td class="actions"><div class="action-group">
                                  {% if user_perms.can_view_facturas %}<a href="{% url 'myapp:factura_detail' fac.pk %}" class="action-icon" title="Ver Factura">👁️</a>{% endif %}
                              </div></td>
                          </tr>
                          {% endfor %}
                      </tbody>
                  </table>
              </div>
          {% else %}
               <p>No hay facturas asociadas a este contrato.</p>
          {% endif %}
        </fieldset>
    </div>
  </section>
</div>

{{ contrato.historial_cambios|json_script:"historial-json-data" }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
      try {
        const jsonDataEl = document.getElementById('historial-json-data');
        const displayElement = document.getElementById('historial-display-{{ contrato.pk }}');
        
        if (jsonDataEl && displayElement) {
            const jsonData = JSON.parse(jsonDataEl.textContent);
            if ((Array.isArray(jsonData) && jsonData.length > 0) || (typeof jsonData === 'object' && jsonData !== null && Object.keys(jsonData).length > 0 && !(Array.isArray(jsonData) && jsonData.length === 0) )) {
                displayElement.textContent = JSON.stringify(jsonData, null, 2);
            } else {
                displayElement.textContent = 'No hay historial de cambios disponible.';
            }
        } else {
            if(displayElement) displayElement.textContent = 'Elemento de historial no encontrado.';
        }
      } catch (e) {
        const displayElement = document.getElementById('historial-display-{{ contrato.pk }}');
        if (displayElement) {
            displayElement.textContent = 'Error al mostrar historial de cambios.';
        }
        console.error("Error parsing or displaying historial_cambios JSON:", e);
      }
    });
</script>
{% endblock content %}