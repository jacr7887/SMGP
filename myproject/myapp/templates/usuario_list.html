{% extends "home.html" %}
{% load static %}
{% load querystring_tags %} {# Â¡Esencial para que la ordenaciÃ³n y paginaciÃ³n funcionen! #}
{% load humanize %}

{% block content %}
<div class="container" role="main" aria-labelledby="main-heading">
  <section>
    <h1 id="main-heading">ğŸ‘¥ Listado de Usuarios del Sistema</h1>

    <div class="header-actions">
      {% if perms.myapp.add_usuario %}
      <a href="{% url 'myapp:usuario_create' %}" class="nav_link" aria-label="Agregar nuevo usuario del sistema">
        â• Nuevo Usuario
      </a>
      {% endif %}
    </div>

    {# Formulario de BÃºsqueda - Corregido para usar 'search' #}
    <form method="get" class="search-form mb-3" action="." aria-label="Formulario de bÃºsqueda de usuarios">
      <input
        type="text"
        name="search" {# CORREGIDO: Usamos 'search' para ser consistentes #}
        placeholder="ğŸ” Buscar por Nombre, Apellido, Correo..."
        value="{{ search_query|default:'' }}" {# Usa la variable de contexto de la vista #}
        aria-label="Campo de bÃºsqueda global"
        class="search-input"
      />
      <button type="submit" class="nav_link">Buscar</button>
      <a href="{% url 'myapp:usuario_list' %}" class="nav_link" style="margin-left: 10px;" title="Limpiar bÃºsqueda y filtros">Limpiar</a>
    </form>

    <div class="table-container" role="region" aria-labelledby="table-caption">
      <table class="data-table" role="table">
        <caption id="table-caption" class="visually-hidden">
          Lista de usuarios registrados en el sistema. Haga clic en las cabeceras para ordenar.
        </caption>
        <thead role="rowgroup">
          <tr role="row">
            {# --- TODAS TUS COLUMNAS, AHORA CON ORDENACIÃ“N --- #}
            <th class="sort-header" scope="col"><a href="?{% query_transform sort='email' order=current_order|toggle_order:'asc' search=search_query page=1 %}">ğŸ“§ Correo {% if current_sort == 'email' %}<span>{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}</span>{% endif %}</a></th>
            <th class="sort-header" scope="col"><a href="?{% query_transform sort='primer_apellido' order=current_order|toggle_order:'asc' search=search_query page=1 %}">ğŸ‘¤ Nombre Completo {% if current_sort == 'primer_apellido' %}<span>{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}</span>{% endif %}</a></th>
            <th class="sort-header" scope="col"><a href="?{% query_transform sort='tipo_usuario' order=current_order|toggle_order:'asc' search=search_query page=1 %}">ğŸ·ï¸ Tipo {% if current_sort == 'tipo_usuario' %}<span>{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}</span>{% endif %}</a></th>
            <th class="sort-header" scope="col"><a href="?{% query_transform sort='nivel_acceso' order=current_order|toggle_order:'asc' search=search_query page=1 %}">ğŸ“Š Nivel {% if current_sort == 'nivel_acceso' %}<span>{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}</span>{% endif %}</a></th>
            <th class="sort-header" scope="col"><a href="?{% query_transform sort='departamento' order=current_order|toggle_order:'asc' search=search_query page=1 %}">ğŸ¢ Departamento {% if current_sort == 'departamento' %}<span>{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}</span>{% endif %}</a></th>
            <th class="sort-header" scope="col"><a href="?{% query_transform sort='intermediario__nombre_completo' order=current_order|toggle_order:'asc' search=search_query page=1 %}">ğŸ¤ Intermediario {% if current_sort == 'intermediario__nombre_completo' %}<span>{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}</span>{% endif %}</a></th>
            <th scope="col">ğŸ“ TelÃ©fono</th>
            <th class="sort-header" scope="col"><a href="?{% query_transform sort='activo' order=current_order|toggle_order:'asc' search=search_query page=1 %}">âœ… Estado {% if current_sort == 'activo' %}<span>{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}</span>{% endif %}</a></th>
            <th class="sort-header" scope="col"><a href="?{% query_transform sort='date_joined' order=current_order|toggle_order:'asc' search=search_query page=1 %}">ğŸ“… Registro {% if current_sort == 'date_joined' %}<span>{% if current_order == 'asc' %}â–²{% else %}â–¼{% endif %}</span>{% endif %}</a></th>
            <th scope="col">âš™ï¸ Acciones</th>
          </tr>
        </thead>
        <tbody role="rowgroup">
          {% for usuario in object_list %}
          <tr role="row">
            <td role="cell" data-label="Correo">{{ usuario.email }}</td>
            <td role="cell" data-label="Nombre Completo">{{ usuario.get_full_name }}</td>
            <td role="cell" data-label="Tipo">{{ usuario.get_tipo_usuario_display }}</td>
            <td role="cell" data-label="Nivel">{{ usuario.get_nivel_acceso_display }}</td>
            <td role="cell" data-label="Departamento">{{ usuario.get_departamento_display|default:"N/A" }}</td>
            <td role="cell" data-label="Intermediario">{{ usuario.intermediario.nombre_completo|default:"N/A" }}</td>
            <td role="cell" data-label="TelÃ©fono">{{ usuario.telefono|default:"N/A" }}</td>
            <td role="cell" data-label="Estado">
                {% if usuario.activo %}
                    <span style="color: green;" title="Usuario activo">âœ… Activo</span>
                {% else %}
                    <span style="color: red;" title="Usuario inactivo">âŒ Inactivo</span>
                {% endif %}
            </td>
            <td role="cell" data-label="Registro">{{ usuario.date_joined|date:"d/m/Y" }}</td>
            <td class="actions" role="cell" data-label="Acciones">
              <div class="action-group">
                <a href="{% url 'myapp:usuario_detail' usuario.pk %}" class="action-icon" title="Ver Detalles">ğŸ‘ï¸</a>
                <a href="{% url 'myapp:usuario_update' usuario.pk %}" class="action-icon" title="Editar">âœï¸</a>
                <a href="{% url 'myapp:usuario_delete' usuario.pk %}" class="action-icon delete-link" title="Eliminar">âŒ</a>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr role="row">
            <td colspan="10" class="no-results" role="cell">
              ğŸ“­ No se encontraron usuarios que coincidan con los criterios de bÃºsqueda.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {# PaginaciÃ³n - Corregida para usar el tag en todas las URLs #}
    {% if is_paginated %}
    <nav aria-label="NavegaciÃ³n de pÃ¡ginas de usuarios">
      <div class="django-pagination">
        <span class="pagination-current">
          PÃ¡gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}.
        </span>
        {% if page_obj.has_previous %}
          <a href="?{% query_transform page=1 %}" class="btn-pagination" aria-label="Primera pÃ¡gina">Â« Primera</a>
          <a href="?{% query_transform page=page_obj.previous_page_number %}" class="btn-pagination" aria-label="PÃ¡gina anterior">â€¹ Anterior</a>
        {% endif %}
        {% if page_obj.has_next %}
          <a href="?{% query_transform page=page_obj.next_page_number %}" class="btn-pagination" aria-label="Siguiente pÃ¡gina">Siguiente â€º</a>
          <a href="?{% query_transform page=page_obj.paginator.num_pages %}" class="btn-pagination" aria-label="Ãšltima pÃ¡gina">Ãšltima Â»</a>
        {% endif %}
      </div>
    </nav>
    {% endif %}

  </section>
</div>
{% endblock content %}