{% extends "home.html" %}
{% load static %}
{% load humanize %}

{% block extra_head %}
{# Solo cargamos el CSS base de DataTables. Los estilos vienen de tu styles.css #}
{% endblock %}

{% block title %}Listado de Contratos Individuales{% endblock %}

{% block content %}
<div class="container" role="main" aria-labelledby="main-heading">
  <section>
    <h1 id="main-heading">üìÑ Listado de Contratos Individuales</h1>

    <div class="header-actions">
      {% if perms.myapp.add_contratoindividual %}
      <a href="{% url 'myapp:contrato_individual_create' %}" class="nav_link" aria-label="Crear nuevo contrato individual">
        ‚ûï Nuevo Contrato Individual
      </a>
      {% endif %}
    </div>

    <div class="table-container">
      <table id="contratos-table" class="data-table" style="width:100%">
        <thead>
          <tr>
            {# --- CABECERAS COMPLETAS (COMO EN TU ORIGINAL) --- #}
            <th>N¬∞ Contrato</th>
            <th>Afiliado</th>
            <th>C√©dula Af.</th>
            <th>Ramo</th>
            <th>Inicio Vig.</th>
            <th>Fin Vig.</th>
            <th>Tarifa</th>
            <th>Prima Total</th>
            <th>Cuota</th>
            <th>F. Pago</th>
            <th>Cuotas</th>
            <th>Pagos R.</th>
            <th>Estatus</th>
            <th>Intermediario</th>
            <th>Activo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for contrato in object_list %}
            {% if contrato.decryption_error %}
              <tr class="table-danger">
                <td colspan="16">‚ö†Ô∏è Error al leer datos para el contrato con ID: {{ contrato.pk }}.</td>
              </tr>
            {% else %}
              <tr>
                {# --- CELDAS COMPLETAS (COMO EN TU ORIGINAL) --- #}
                <td><a href="{% url 'myapp:contrato_individual_detail' contrato.pk %}" title="Ver detalle">{{ contrato.numero_contrato|default:"-" }}</a></td>
                <td>{{ contrato.afiliado.nombre_completo|default:"-" }}</td>
                <td>{{ contrato.afiliado.cedula|default:"-" }}</td>
                <td>{{ contrato.get_ramo_display }}</td>
                <td>{{ contrato.fecha_inicio_vigencia|date:"d/m/Y"|default:"-" }}</td>
                <td>{{ contrato.fecha_fin_vigencia|date:"d/m/Y"|default:"-" }}</td>
                <td title="{{ contrato.tarifa_aplicada }}">
                  {% if contrato.tarifa_aplicada %}
                    {{ contrato.tarifa_aplicada.codigo_tarifa|truncatechars:15|default:"-" }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end">${{ contrato.monto_total|floatformat:2|intcomma|default:"0.00" }}</td>
                <td class="text-end">${{ contrato.monto_cuota_estimada|floatformat:2|intcomma|default:"-" }}</td>
                <td>{{ contrato.get_forma_pago_display }}</td>
                <td class="text-end">{{ contrato.cantidad_cuotas_estimadas|default:"-" }}</td>
                <td class="text-end">{{ contrato.pagos_realizados|default:"0" }}</td>
                <td><span class="badge {% if contrato.estatus == 'VIGENTE' %}badge-success{% elif contrato.estatus == 'VENCIDO' %}badge-danger{% else %}badge-warning{% endif %}">{{ contrato.get_estatus_display }}</span></td>
                <td>{{ contrato.intermediario.nombre_completo|default:"-" }}</td>
                <td class="text-center">
                  {% if contrato.activo %}
                    <span class="badge badge-success">S√≠</span>
                  {% else %}
                    <span class="badge badge-danger">No</span>
                  {% endif %}
                </td>
                <td class="actions">
                  <div class="action-group">
                    <a href="{% url 'myapp:contrato_individual_detail' contrato.pk %}" class="action-icon" title="Ver Detalles">üëÅÔ∏è</a>
                    <a href="{% url 'myapp:contrato_individual_update' contrato.pk %}" class="action-icon" title="Editar">‚úèÔ∏è</a>
                    <a href="{% url 'myapp:contrato_individual_delete' contrato.pk %}" class="action-icon delete-link" title="Eliminar">‚ùå</a>
                  </div>
                </td>
              </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</div>
{% endblock content %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    $('#contratos-table').DataTable({
        language: { "url": "//cdn.datatables.net/plug-ins/2.0.8/i18n/es-ES.json" },
        "dom":
            "<'dt-layout-row'<'dt-layout-cell dt-start'l><'dt-layout-cell dt-end'f>>" +
            "<'dt-layout-row'<'dt-layout-cell dt-full-width'tr>>" +
            "<'dt-layout-row'<'dt-layout-cell dt-start'i><'dt-layout-cell dt-end'p>>",
        "columnDefs": [
            { "orderable": false, "targets": -1 } // Deshabilita ordenar en la √∫ltima columna (Acciones)
        ]
    });
});
</script>
{% endblock %}