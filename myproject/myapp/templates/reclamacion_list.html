{% extends "home.html" %}
{% load static %}
{% load querystring_tags %}
{% load humanize %}

{% block content %}
<div class="container" role="main" aria-labelledby="main-heading">
  <section>
    <h1 id="main-heading">📢 Listado Completo de Reclamaciones</h1>

    <div class="header-actions">
      {% if perms.myapp.add_reclamacion %}
      <a href="{% url 'myapp:reclamacion_create' %}" class="nav_link" aria-label="Crear nueva reclamación">
        ➕ Nueva Reclamación
      </a>
      {% endif %}
    </div>

    <form method="get" class="search-form mb-3" action="." aria-label="Formulario de búsqueda de reclamaciones">
      <input
        type="text"
        name="search"
        placeholder="🔍 Buscar..."
        value="{{ search_query|escape|default:'' }}"
        aria-label="Campo de búsqueda global"
        class="search-input"
      />
      <button type="submit" class="nav_link">Buscar</button>
      <a href="{% url 'myapp:reclamacion_list' %}" class="nav_link" style="margin-left: 10px;" title="Limpiar búsqueda y filtros">Limpiar</a>
    </form>

    <div class="table-container" role="region" aria-labelledby="table-caption">
      <table class="data-table" role="table">
        <caption id="table-caption" class="visually-hidden">
          Lista completa de reclamaciones registradas. Haga clic en las cabeceras para ordenar.
        </caption>
        <thead role="rowgroup">
          <tr role="row">
            <th class="sort-header" role="columnheader">
                <a href="?{% query_transform sort='numero_reclamacion' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">
                    #️⃣ N° Reclam. {% if current_sort == 'numero_reclamacion' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}
                </a>
            </th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='tipo_reclamacion' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">🏷️ Tipo {% if current_sort == 'tipo_reclamacion' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='estado' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">🚦 Estado {% if current_sort == 'estado' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='contrato_individual__numero_contrato' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">📄 Contrato Ind. {% if current_sort == 'contrato_individual__numero_contrato' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='contrato_colectivo__razon_social' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">📑 Contrato Col. {% if current_sort == 'contrato_colectivo__razon_social' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='fecha_reclamo' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">📅 F. Reclamo {% if current_sort == 'fecha_reclamo' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='fecha_cierre_reclamo' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">🏁 F. Cierre {% if current_sort == 'fecha_cierre_reclamo' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='monto_reclamado' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">💰 Monto Reclamado {% if current_sort == 'monto_reclamado' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='descripcion_reclamo' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">📝 Descripción {% if current_sort == 'descripcion_reclamo' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='diagnostico_principal' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">ℹ️ Diagnóstico {% if current_sort == 'diagnostico_principal' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='usuario_asignado__username' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">👤 Usuario Asig. {% if current_sort == 'usuario_asignado__username' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th role="columnheader">📎 Docs. Adjuntos</th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='observaciones_internas' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">🤫 Obs. Internas {% if current_sort == 'observaciones_internas' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='observaciones_cliente' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">🗣️ Obs. Cliente {% if current_sort == 'observaciones_cliente' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='fecha_creacion' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">➕ F. Creación {% if current_sort == 'fecha_creacion' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='fecha_modificacion' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">🔄 F. Modificación {% if current_sort == 'fecha_modificacion' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='activo' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">💡 Activo {% if current_sort == 'activo' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th role="columnheader">⚙️ Acciones</th>
          </tr>
        </thead>
        <tbody role="rowgroup">
          {% for reclamacion in object_list %}
          <tr role="row">
            <td role="cell">{{ reclamacion.numero_reclamacion|default:"PENDIENTE" }}</td>
            <td role="cell">{{ reclamacion.get_tipo_reclamacion_display|escape|default:"-" }}</td>
            <td role="cell">
                <span class="badge 
                    {% if reclamacion.estado == 'APROBADA' or reclamacion.estado == 'PAGADA' %}
                        badge-success
                    {% elif reclamacion.estado == 'CERRADA' or reclamacion.estado == 'RECHAZADA' %}
                        badge-danger
                    {% elif reclamacion.estado == 'ABIERTA' or reclamacion.estado == 'EN_PROCESO' or reclamacion.estado == 'PENDIENTE_DOCS' or reclamacion.estado == 'EN_ANALISIS' or reclamacion.estado == 'ESCALADA' or reclamacion.estado == 'EN_ARBITRAJE' or reclamacion.estado == 'INVESTIGACION' %}
                        badge-warning
                    {% elif reclamacion.estado == 'SUSPENDIDA' %}
                        badge-info 
                    {% else %}
                        badge-secondary
                    {% endif %}
                ">
                    {{ reclamacion.get_estado_display|escape|default:"-" }}
                </span>
            </td>
            <td role="cell">{% if reclamacion.contrato_individual %}<a href="{% url 'myapp:contrato_individual_detail' reclamacion.contrato_individual.pk %}">{{ reclamacion.contrato_individual.numero_contrato|default:"N/A" }}</a>{% else %}-{% endif %}</td>
            <td role="cell">{% if reclamacion.contrato_colectivo %}<a href="{% url 'myapp:contrato_colectivo_detail' reclamacion.contrato_colectivo.pk %}">{{ reclamacion.contrato_colectivo.numero_contrato|default:"N/A" }}</a>{% else %}-{% endif %}</td>
            <td role="cell">{{ reclamacion.fecha_reclamo|date:"d/m/Y"|default:"-" }}</td>
            <td role="cell">{{ reclamacion.fecha_cierre_reclamo|date:"d/m/Y"|default:"-" }}</td>
            <td role="cell" style="text-align: right;">${{ reclamacion.monto_reclamado|floatformat:2|intcomma|default:"0.00" }}</td>
            <td role="cell" title="{{ reclamacion.descripcion_reclamo|escape|default:'' }}">{{ reclamacion.descripcion_reclamo|escape|truncatechars:50|default:"-" }}</td>
            <td role="cell" title="{{ reclamacion.get_diagnostico_principal_display|escape|default:'' }}">{{ reclamacion.get_diagnostico_principal_display|escape|truncatechars:50|default:"-" }}</td>
            <td role="cell">{{ reclamacion.usuario_asignado.get_full_name|escape|default:"-" }}</td>
            <td role="cell">{% if reclamacion.documentos_adjuntos %}<a href="{{ reclamacion.documentos_adjuntos.url }}" class="file-popup-trigger" data-popup-title="Soporte de Reclamación #{{ reclamacion.numero_reclamacion|default:reclamacion.pk }}">📎 Ver</a>{% else %}-{% endif %}</td>
            <td role="cell" title="{{ reclamacion.observaciones_internas|escape|default:'' }}">{{ reclamacion.observaciones_internas|escape|truncatechars:40|default:"-" }}</td>
            <td role="cell" title="{{ reclamacion.observaciones_cliente|escape|default:'' }}">{{ reclamacion.observaciones_cliente|escape|truncatechars:40|default:"-" }}</td>
            <td role="cell">{{ reclamacion.fecha_creacion|date:"d/m/y H:i"|default:"-" }}</td>
            <td role="cell">{{ reclamacion.fecha_modificacion|date:"d/m/y H:i"|default:"-" }}</td>
            <td role="cell">{% if reclamacion.activo %}✅ Sí{% else %}🔴 No{% endif %}</td>

            <td class="actions" role="cell">
              <div class="action-group">
                 {% if perms.myapp.view_reclamacion %}
                  <a href="{% url 'myapp:reclamacion_detail' reclamacion.pk %}" class="action-icon" title="Ver Detalles" aria-label="Ver detalles de la reclamación {{ reclamacion.numero_reclamacion|default:reclamacion.pk }}">👁️</a>
                {% endif %}
                {% if perms.myapp.change_reclamacion %}
                  <a href="{% url 'myapp:reclamacion_update' reclamacion.pk %}" class="action-icon" title="Editar" aria-label="Editar reclamación {{ reclamacion.numero_reclamacion|default:reclamacion.pk }}">✏️</a>
                {% endif %}
                {% if perms.myapp.delete_reclamacion %}
                  <a href="{% url 'myapp:reclamacion_delete' reclamacion.pk %}" class="action-icon delete-link" title="Eliminar" aria-label="Eliminar reclamación {{ reclamacion.numero_reclamacion|default:reclamacion.pk }}">❌</a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr role="row">
            <td colspan="18" class="no-results" role="cell">
              📭 No se encontraron reclamaciones que coincidan con la búsqueda{% if search_query %} para "{{ search_query|escape }}"{% endif %}.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if is_paginated %}
    <nav aria-label="Navegación de páginas de reclamaciones">
      <div class="django-pagination">
        <span class="pagination-current">
          Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        </span>
        {% if page_obj.has_previous %}
          <a href="?{% query_transform page=1 %}" class="btn-pagination" aria-label="Primera página">« Primera</a>
          <a href="?{% query_transform page=page_obj.previous_page_number %}" class="btn-pagination" aria-label="Página anterior">‹ Anterior</a>
        {% endif %}
        {% if page_obj.has_next %}
          <a href="?{% query_transform page=page_obj.next_page_number %}" class="btn-pagination" aria-label="Siguiente página">Siguiente ›</a>
          <a href="?{% query_transform page=page_obj.paginator.num_pages %}" class="btn-pagination" aria-label="Última página">Última »</a>
        {% endif %}
      </div>
    </nav>
    {% endif %}

  </section>
</div>

{% endblock content %}