{% extends "home.html" %}
{% load static %}
{% load humanize %}

{% block extra_head %}
{# Solo cargamos el CSS base de DataTables. Los estilos ya est√°n en styles.css #}
{% endblock %}

{% block title %}Listado de Reclamaciones{% endblock %}

{% block content %}
<div class="container" role="main" aria-labelledby="main-heading">
  <section>
    <h1 id="main-heading">üÜò Listado de Reclamaciones</h1>

    <div class="header-actions">
      {% if perms.myapp.add_reclamacion %}
      <a href="{% url 'myapp:reclamacion_create' %}" class="nav_link">
        ‚ûï Nueva Reclamaci√≥n
      </a>
      {% endif %}
    </div>

    <div class="table-container">
      {# DataTables a√±adir√° su propio campo de b√∫squeda y paginaci√≥n #}
      <table id="reclamaciones-table" class="data-table" style="width:100%">
        <thead>
          <tr>
            {# --- CABECERAS COMPLETAS (DE TU PLANTILLA ORIGINAL) --- #}
            <th>N¬∞ Reclam.</th>
            <th>Primer Nombre</th>
            <th>Segundo Nombre</th>
            <th>Primer Apellido</th>
            <th>Segundo Apellido</th>
            <th>Tipo</th>
            <th>Estado</th>
            <th>Contrato Ind.</th>
            <th>Contrato Col.</th>
            <th>F. Reclamo</th>
            <th>F. Cierre</th>
            <th>Monto</th>
            <th>Descripci√≥n</th>
            <th>Diagn√≥stico</th>
            <th>Usuario Asig.</th>
            <th>Docs. Adjuntos</th>
            <th>Obs. Internas</th>
            <th>Obs. Cliente</th>
            <th>F. Creaci√≥n</th>
            <th>F. Modificaci√≥n</th>
            <th>Activo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for reclamacion in object_list %}
            {% if reclamacion.decryption_error %}
              <tr class="table-danger">
                <td colspan="22">‚ö†Ô∏è Error al leer datos para la reclamaci√≥n con ID: {{ reclamacion.pk }}.</td>
              </tr>
            {% else %}
              <tr>
                {# --- CELDAS COMPLETAS (DE TU PLANTILLA ORIGINAL) --- #}
                <td><a href="{% url 'myapp:reclamacion_detail' reclamacion.pk %}">{{ reclamacion.numero_reclamacion|default:"-" }}</a></td>
                <td>{{ reclamacion.primer_nombre|default:"-" }}</td>
                <td>{{ reclamacion.segundo_nombre|default:"-" }}</td>
                <td>{{ reclamacion.primer_apellido|default:"-" }}</td>
                <td>{{ reclamacion.segundo_apellido|default:"-" }}</td>
                <td>{{ reclamacion.get_tipo_reclamacion_display|default:"-" }}</td>
                <td>
                  {# --- L√ìGICA DE BADGES COMPLETA Y CORRECTA --- #}
                  <span class="badge 
                    {% if reclamacion.estado == 'APROBADA' or reclamacion.estado == 'PAGADA' %}badge-success
                    {% elif reclamacion.estado == 'RECHAZADA' or reclamacion.estado == 'ANULADA' %}badge-danger
                    {% elif reclamacion.estado == 'ABIERTA' or reclamacion.estado == 'PENDIENTE_DOCS' %}badge-warning
                    {% elif reclamacion.estado ==  'CERRADA' %}badge-secondary
                    {% else %}badge-info{% endif %}">
                    {{ reclamacion.get_estado_display|default:"-" }}
                  </span>
                </td>
                <td>{% if reclamacion.contrato_individual %}<a href="{% url 'myapp:contrato_individual_detail' reclamacion.contrato_individual.pk %}">{{ reclamacion.contrato_individual.numero_contrato|default:"N/A" }}</a>{% else %}-{% endif %}</td>
                <td>{% if reclamacion.contrato_colectivo %}<a href="{% url 'myapp:contrato_colectivo_detail' reclamacion.contrato_colectivo.pk %}">{{ reclamacion.contrato_colectivo.razon_social|truncatechars:20|default:"N/A" }}</a>{% else %}-{% endif %}</td>
                <td>{{ reclamacion.fecha_reclamo|date:"d/m/Y"|default:"-" }}</td>
                <td>{{ reclamacion.fecha_cierre_reclamo|date:"d/m/Y"|default:"-" }}</td>
                <td class="text-end">${{ reclamacion.monto_reclamado|floatformat:2|intcomma|default:"0.00" }}</td>
                <td title="{{ reclamacion.descripcion_reclamo|escape }}">{{ reclamacion.descripcion_reclamo|truncatechars:30|default:"-" }}</td>
                <td title="{{ reclamacion.get_diagnostico_principal_display|escape }}">{{ reclamacion.get_diagnostico_principal_display|truncatechars:20|default:"-" }}</td>
                <td>{{ reclamacion.usuario_asignado.get_full_name|default:"-" }}</td>
                <td>
                  {# --- CORRECCI√ìN: A√±adida la clase file-popup-trigger --- #}
                  {% if reclamacion.documentos_adjuntos %}
                    <a href="{{ reclamacion.documentos_adjuntos.url }}" class="file-popup-trigger" target="_blank">üìé Ver</a>
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td title="{{ reclamacion.observaciones_internas|escape }}">{{ reclamacion.observaciones_internas|truncatechars:30|default:"-" }}</td>
                <td title="{{ reclamacion.observaciones_cliente|escape }}">{{ reclamacion.observaciones_cliente|truncatechars:30|default:"-" }}</td>
                <td>{{ reclamacion.fecha_creacion|date:"d/m/y H:i"|default:"-" }}</td>
                <td>{{ reclamacion.fecha_modificacion|date:"d/m/y H:i"|default:"-" }}</td>
                <td class="text-center">
                  {% if reclamacion.activo %}
                    <span class="badge badge-success">S√≠</span>
                  {% else %}
                    <span class="badge badge-danger">No</span>
                  {% endif %}
                </td>
                <td class="actions">
                  <div class="action-group">
                    <a href="{% url 'myapp:reclamacion_detail' reclamacion.pk %}" class="action-icon" title="Ver">üëÅÔ∏è</a>
                    <a href="{% url 'myapp:reclamacion_update' reclamacion.pk %}" class="action-icon" title="Editar">‚úèÔ∏è</a>
                    <a href="{% url 'myapp:reclamacion_delete' reclamacion.pk %}" class="action-icon delete-link" title="Eliminar">‚ùå</a>
                  </div>
                </td>
              </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</div>
{% endblock content %}

{% block extra_scripts %}

<script>
$(document).ready(function() {
    $('#reclamaciones-table').DataTable({
        language: { "url": "//cdn.datatables.net/plug-ins/2.0.8/i18n/es-ES.json" },
        "dom":
            "<'dt-layout-row'<'dt-layout-cell dt-start'l><'dt-layout-cell dt-end'f>>" +
            "<'dt-layout-row'<'dt-layout-cell dt-full-width'tr>>" +
            "<'dt-layout-row'<'dt-layout-cell dt-start'i><'dt-layout-cell dt-end'p>>",
        "columnDefs": [
            { "orderable": false, "targets": -1 } // Deshabilita ordenar en la √∫ltima columna (Acciones)
        ]
    });
});
</script>
{% endblock %}