{% extends "home.html" %}
{% load static %}
{% load humanize %}

{% block extra_head %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
{% endblock %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container" role="main" aria-labelledby="main-heading">
  <section>
    <h1 id="main-heading">🧾 {{ title }}</h1>

    <div class="header-actions">
      {% if perms.myapp.add_factura %}
      <a href="{% url 'myapp:factura_create' %}" class="nav_link">
        ➕ Nueva Factura
      </a>
      {% endif %}
    </div>

    <div class="table-container">
      <table id="facturas-table" class="data-table" style="width:100%">
        <thead>
          <tr>
            <th>N° Recibo</th>
            <th>Contrato Asociado</th>
            <th>Monto</th>
            <th>Pendiente</th>
            <th>Estatus</th>
            <th>Pagada</th>
            <th>Vigencia Desde</th>
            <th>Vigencia Hasta</th>
            <th>Intermediario</th>
            <th>Activo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for factura in object_list %}
              <tr>
                <td><a href="{% url 'myapp:factura_detail' factura.pk %}" title="Ver detalle">{{ factura.numero_recibo|default:"-" }}</a></td>
                <td>
                    {% if factura.contrato_individual %}
                        <a href="{% url 'myapp:contrato_individual_detail' factura.contrato_individual.pk %}">
                            CI: {{ factura.contrato_individual.numero_contrato }}
                        </a>
                    {% elif factura.contrato_colectivo %}
                        <a href="{% url 'myapp:contrato_colectivo_detail' factura.contrato_colectivo.pk %}">
                            CC: {{ factura.contrato_colectivo.numero_contrato }}
                        </a>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="text-end">${{ factura.monto|floatformat:2|intcomma|default:"0.00" }}</td>
                <td class="text-end">${{ factura.monto_pendiente|floatformat:2|intcomma|default:"0.00" }}</td>
                <td>
                  {# --- ¡AQUÍ ESTÁ LA CORRECCIÓN DE BADGES! --- #}
                  <span class="badge 
                      {% if factura.estatus_factura == 'PAGADA' %}badge-success
                      {% elif factura.estatus_factura == 'VENCIDA' or factura.estatus_factura == 'ANULADA' %}badge-danger
                      {% elif factura.estatus_factura == 'PENDIENTE' %}badge-warning
                      {% else %}badge-info{% endif %}">
                      {{ factura.get_estatus_factura_display }}
                  </span>
                </td>
                <td class="text-center">
                    {% if factura.pagada %}
                        <span class="badge badge-success">Sí</span>
                    {% else %}
                        <span class="badge badge-danger">No</span>
                    {% endif %}
                </td>
                <td>{{ factura.vigencia_recibo_desde|date:"d/m/Y"|default:"-" }}</td>
                <td>{{ factura.vigencia_recibo_hasta|date:"d/m/Y"|default:"-" }}</td>
                <td>{{ factura.intermediario.nombre_completo|default:"-" }}</td>
                <td class="text-center">
                  {% if factura.activo %}
                    <span class="badge badge-success">Sí</span>
                  {% else %}
                    <span class="badge badge-danger">No</span>
                  {% endif %}
                </td>
                <td class="actions">
                  <div class="action-group">
                    <a href="{% url 'myapp:factura_detail' factura.pk %}" class="action-icon" title="Ver Detalles">👁️</a>
                    <a href="{% url 'myapp:factura_update' factura.pk %}" class="action-icon" title="Editar">✏️</a>
                    <a href="{% url 'myapp:factura_delete' factura.pk %}" class="action-icon delete-link" title="Eliminar">❌</a>
                  </div>
                </td>
              </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</div>
{% endblock content %}

{% block extra_scripts %}
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
<script>
$(document).ready(function() {
    $('#facturas-table').DataTable({
        language: { "url": "//cdn.datatables.net/plug-ins/2.0.8/i18n/es-ES.json" },
        "dom":
            "<'dt-layout-row'<'dt-layout-cell dt-start'l><'dt-layout-cell dt-end'f>>" +
            "<'dt-layout-row'<'dt-layout-cell dt-full-width'tr>>" +
            "<'dt-layout-row'<'dt-layout-cell dt-start'i><'dt-layout-cell dt-end'p>>",
        "columnDefs": [
            { "orderable": false, "targets": -1 }
        ]
    });
});
</script>
{% endblock %}