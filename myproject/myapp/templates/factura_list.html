{% extends "home.html" %}
{% load static %}
{% load querystring_tags %} {# Necesario para query_transform y toggle_order (si está aquí) #}
{% load humanize %} {# Para intcomma #}
{# Carga aquí la librería que contenga 'toggle_order' si es personalizada #}
{# {% load tu_libreria_de_tags %} #}

{% block content %}
<div class="container" role="main" aria-labelledby="main-heading">
  <section>
    <h1 id="main-heading">🧾 Listado Completo de Facturas</h1>

    <div class="header-actions">
      {% if perms.myapp.add_factura %} {# Asegúrate que 'myapp' sea correcto #}
      <a href="{% url 'myapp:factura_create' %}" class="nav_link" aria-label="Crear nueva factura">
        ➕ Nueva Factura
      </a>
      {% endif %}
    </div>

    <form method="get" class="search-form mb-3" action="." aria-label="Formulario de búsqueda de facturas">
      <input
        type="text"
        name="search"
        placeholder="🔍 Buscar..."
        value="{{ search_query|escape|default:'' }}"
        aria-label="Campo de búsqueda global"
        class="search-input"
      />
      <button type="submit" class="nav_link">Buscar</button>
      <a href="{% url 'myapp:factura_list' %}" class="nav_link" style="margin-left: 10px;" title="Limpiar búsqueda y filtros">Limpiar</a>
    </form>

    {# Formulario de filtros (si aplica) #}
    {# {% if filter %} ... {% endif %} #}

    <div class="table-container" role="region" aria-labelledby="table-caption">
      <table class="data-table" role="table">
        <caption id="table-caption" class="visually-hidden">
          Lista completa de facturas registradas. Haga clic en las cabeceras para ordenar.
        </caption>
        <thead role="rowgroup">
          <tr role="row">
            {# --- Cabeceras Ordenables (Mantenidas como en el original) --- #}
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='numero_recibo' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">🧾 N° Recibo {% if current_sort == 'numero_recibo' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='contrato_individual__numero_contrato' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">📄 Contrato Ind. {% if current_sort == 'contrato_individual__numero_contrato' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='contrato_colectivo__razon_social' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">📑 Contrato Col. {% if current_sort == 'contrato_colectivo__razon_social' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='intermediario__nombre_completo' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">🤝 Intermediario {% if current_sort == 'intermediario__nombre_completo' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader">
                <a href="?{% query_transform sort='ramo_anotado' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">
                    🌿 Ramo {% if current_sort == 'ramo_anotado' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}
                </a>
            </th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='vigencia_recibo_desde' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">▶️ Vig. Desde {% if current_sort == 'vigencia_recibo_desde' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='vigencia_recibo_hasta' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">⏹️ Vig. Hasta {% if current_sort == 'vigencia_recibo_hasta' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='dias_periodo_cobro' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">⏳ Días Per. {% if current_sort == 'dias_periodo_cobro' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='monto' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">💰 Monto {% if current_sort == 'monto' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='monto_pendiente' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">⏳ Monto Pend. {% if current_sort == 'monto_pendiente' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='pagada' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">✅ Pagada {% if current_sort == 'pagada' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            {# --- NUEVA Cabecera Ordenable IGTF --- #}
            <th class="sort-header" role="columnheader">
                <a href="?{% query_transform sort='aplica_igtf' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">
                    💲 IGTF {% if current_sort == 'aplica_igtf' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}
                </a>
            </th>
            {# --- FIN NUEVA Cabecera IGTF --- #}
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='estatus_factura' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">🚦 Estatus Fact. {% if current_sort == 'estatus_factura' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='estatus_emision' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">📦 Estatus Emisión {% if current_sort == 'estatus_emision' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='relacion_ingreso' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">🔗 Rel. Ingreso {% if current_sort == 'relacion_ingreso' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='live_installments_remaining' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">🔢 Rec. Pend. {% if current_sort == 'live_installments_remaining' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            {# --- NUEVA Cabecera Observaciones (No ordenable) --- #}
            <th role="columnheader">📝 Obs.</th>
            {# --- FIN NUEVA Cabecera Observaciones --- #}
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='activo' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">💡 Activo {% if current_sort == 'activo' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='fecha_creacion' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">➕ F. Creación {% if current_sort == 'fecha_creacion' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th class="sort-header" role="columnheader"><a href="?{% query_transform sort='fecha_modificacion' order=current_order|toggle_order:'asc' search=search_query page=1 %}{% for key, value in filter.form.cleaned_data.items %}{% if value %}&{{ key }}={{ value|urlencode }}{% endif %}{% endfor %}">🔄 F. Modificación {% if current_sort == 'fecha_modificacion' %}{% if current_order == 'asc' %}▲{% else %}▼{% endif %}{% else %}↕️{% endif %}</a></th>
            <th role="columnheader">⚙️ Acciones</th>
          </tr>
        </thead>
        <tbody role="rowgroup">
          {% for factura in object_list %}
          <tr role="row">
            <td role="cell">{{ factura.numero_recibo|escape|default:"-" }}</td>
            <td role="cell">{% if factura.contrato_individual %}<a href="{% url 'myapp:contrato_individual_detail' factura.contrato_individual.pk %}">{{ factura.contrato_individual.numero_contrato }}</a>{% else %}-{% endif %}</td>
            <td role="cell">{% if factura.contrato_colectivo %}<a href="{% url 'myapp:contrato_colectivo_detail' factura.contrato_colectivo.pk %}">{{ factura.contrato_colectivo.numero_contrato }}</a>{% else %}-{% endif %}</td>
            <td role="cell" title="{{ factura.intermediario.nombre_completo|escape|default:'' }}">{% if factura.intermediario %}<a href="{% url 'myapp:intermediario_detail' factura.intermediario.pk %}">{{ factura.intermediario.nombre_completo|escape|truncatechars:15 }}</a>{% else %}-{% endif %}</td>
            <td role="cell">{{ factura.ramo_anotado|escape|default:"-" }}</td>            
            <td role="cell">{{ factura.vigencia_recibo_desde|date:"d/m/Y"|default:"-" }}</td>
            <td role="cell">{{ factura.vigencia_recibo_hasta|date:"d/m/Y"|default:"-" }}</td>
            <td role="cell">{{ factura.dias_periodo_cobro|default:"-" }}</td>
            <td role="cell" style="text-align: right;">${{ factura.monto|floatformat:2|intcomma|default:"0.00" }}</td>
            <td role="cell" style="text-align: right;">${{ factura.monto_pendiente|floatformat:2|intcomma|default:"0.00" }}</td>
            <td role="cell">{% if factura.pagada %}✅ Sí{% else %}❌ No{% endif %}</td>
            {# --- NUEVA Celda IGTF --- #}
            <td role="cell">{% if factura.aplica_igtf %}✅ Sí{% else %}❌ No{% endif %}</td>
            {# --- FIN NUEVA Celda IGTF --- #}
            <td role="cell"><span class="badge {% if factura.estatus_factura == 'PAGADA' %}badge-success{% elif factura.estatus_factura == 'VENCIDA' %}badge-danger{% else %}badge-warning{% endif %}">{{ factura.get_estatus_factura_display|escape }}</span></td>
            <td role="cell">{{ factura.get_estatus_emision_display|escape|default:"-" }}</td>
            <td role="cell" title="{{ factura.relacion_ingreso|escape }}">{{ factura.relacion_ingreso|escape|truncatechars:10|default:"-" }}</td>
            <td role="cell">{{ factura.live_installments_remaining|default:"0" }}</td>
             {# --- NUEVA Celda Observaciones --- #}
            <td role="cell" title="{{ factura.observaciones|escape|default:'' }}">
                {{ factura.observaciones|escape|truncatechars:20|default:"-" }}
            </td>
            {# --- FIN NUEVA Celda Observaciones --- #}
            <td role="cell">{% if factura.activo %}✅ Sí{% else %}🔴 No{% endif %}</td>
            <td role="cell">{{ factura.fecha_creacion|date:"d/m/y H:i"|default:"-" }}</td>
            <td role="cell">{{ factura.fecha_modificacion|date:"d/m/y H:i"|default:"-" }}</td>

            <td class="actions" role="cell">
              <div class="action-group">
                 {% if perms.myapp.view_factura %}
                  <a href="{% url 'myapp:factura_detail' factura.pk %}" class="action-icon" title="Ver Detalles" aria-label="Ver detalles de la factura {{ factura.numero_recibo|escape }}">👁️</a>
                {% endif %}
                {% if perms.myapp.change_factura %}
                  <a href="{% url 'myapp:factura_update' factura.pk %}" class="action-icon" title="Editar" aria-label="Editar factura {{ factura.numero_recibo|escape }}">✏️</a>
                {% endif %}
                {% if perms.myapp.delete_factura %}
                  <a href="{% url 'myapp:factura_delete' factura.pk %}" class="action-icon delete-link" title="Eliminar" aria-label="Eliminar factura {{ factura.numero_recibo|escape }}">❌</a>
                {% endif %}
                 {% if perms.myapp.view_factura %}
                    <a href="{% url 'myapp:factura_pdf' pk=factura.pk %}" class="action-icon" title="Ver PDF" target="_blank">📄</a>
                 {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr role="row">
            {# --- Colspan ajustado a 22 --- #}
            <td colspan="22" class="no-results" role="cell">
              📭 No se encontraron facturas que coincidan con la búsqueda{% if search_query %} para "{{ search_query|escape }}"{% endif %}.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {# --- Paginación (CORREGIDA - SIN 'request') --- #}
    {% if is_paginated %}
    <nav aria-label="Navegación de páginas de facturas">
      <div class="django-pagination">
        <span class="pagination-current">
          Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        </span>
        {% if page_obj.has_previous %}
          {# Removido 'request' como primer argumento #}
          <a href="?{% query_transform page=1 %}" class="btn-pagination" aria-label="Primera página">« Primera</a>
          <a href="?{% query_transform page=page_obj.previous_page_number %}" class="btn-pagination" aria-label="Página anterior">‹ Anterior</a>
        {% endif %}
        {% if page_obj.has_next %}
           {# Removido 'request' como primer argumento #}
          <a href="?{% query_transform page=page_obj.next_page_number %}" class="btn-pagination" aria-label="Siguiente página">Siguiente ›</a>
          <a href="?{% query_transform page=page_obj.paginator.num_pages %}" class="btn-pagination" aria-label="Última página">Última »</a>
        {% endif %}
      </div>
    </nav>
    {% endif %}
    {# --- FIN CORRECCIÓN PAGINACIÓN --- #}

  </section>
</div>

{# --- CSS/JS (Mantener al final si home.html no los carga) --- #}
{# <link rel="stylesheet" href="{% static 'css/styles.css' %}"> #}
{# <script src="{% static 'js/scripts.js' %}"></script> #}
{% endblock content %}