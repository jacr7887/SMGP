{% extends "base.html" %}
{% load static humanize %}
{% load comision_tags %} {# Necesario para filter_has_override #}
{% load querystring_tags %} {# Necesario para query_transform y toggle_order #}

{% block title %}{{ page_title|default:"Mis Comisiones" }}{% endblock %}

{% block content %}
<div class="dark-container page-list-view" role="main" aria-labelledby="main-heading-mis-comisiones">
  <section>
    <div class="list-header">
        <h1 id="main-heading-mis-comisiones" class="main-title">{{ page_title|default:"üí∏ Mis Comisiones Registradas" }}</h1>
        {# Puedes a√±adir un bot√≥n de acci√≥n aqu√≠ si es relevante, ej. exportar mis comisiones #}
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show compact-form" role="alert">
                {{ message|escape }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
            </div>
        {% endfor %}
    {% endif %}

    <form method="get" class="search-form mb-3" action="." aria-label="Formulario de b√∫squeda de mis comisiones">
      <input
        type="text"
        name="search"
        class="search-input"
        placeholder="üîç Buscar por ID, Factura, Tipo, Estado..."
        value="{{ search_query|default_if_none:'' }}"
        aria-label="T√©rmino de b√∫squeda"
      />
      <button type="submit" class="nav_link">Buscar</button>
      <a href="{% url 'myapp:mis_comisiones_list' %}" class="nav_link" style="margin-left: 10px;" title="Limpiar b√∫squeda">Limpiar</a>
    </form>

    {# --- FORMULARIO DE B√öSQUEDA SIMPLE --- #}
    <form method="get" class="search-form mb-3" action="." aria-label="Formulario de b√∫squeda de mis comisiones">
      <input
        type="text"
        name="search" {# El nombre del par√°metro que tu MisComisionesListView.get_queryset espera #}
        class="search-input"
        placeholder="üîç Buscar por ID, Factura, Tipo, Estado..."
        value="{{ search_query|default_if_none:'' }}" {# search_query viene del contexto de la vista #}
        aria-label="T√©rmino de b√∫squeda"
      />
      <button type="submit" class="nav_link">Buscar</button>
      <a href="{% url 'myapp:mis_comisiones_list' %}" class="nav_link" style="margin-left: 10px;" title="Limpiar b√∫squeda">Limpiar</a>
    </form>
    {# --- FIN FORMULARIO DE B√öSQUEDA SIMPLE --- #}


    <div class="table-container glass-card">
        {% if comisiones %}
        <table class="data-table">
            <thead>
                <tr>
                    {% for field_key, field_label in ordering_options.items %}
                    <th class="sort-header">
                        <a href="?{% query_transform sort=field_key order=current_order|toggle_order:'asc' search=search_query page=1 %}{% if preserved_filters_for_ordering %}&{{ preserved_filters_for_ordering }}{% endif %}">
                            {{ field_label }}
                            {% if current_sort == field_key %}<span>{% if current_order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}</span>{% else %}<span>‚ÜïÔ∏è</span>{% endif %}
                        </a>
                    </th>
                    {% endfor %}
                    <th class="actions-header">üëÅÔ∏è Ver</th>
                </tr>
            </thead>
            <tbody>
                {% for comision_item in comisiones %} {# Renombrar para evitar conflicto con la lista del contexto #}
                <tr>
                    <td>{{ comision_item.pk }}</td>
                    <td>{{ comision_item.get_tipo_comision_display|escape }}</td>
                    <td class="text-end">${{ comision_item.monto_comision|floatformat:2|intcomma|default:"0.00" }}</td>
                    <td class="text-end">${{ comision_item.monto_base_calculo|floatformat:2|intcomma|default:"0.00" }}</td>
                    <td class="text-end">{{ comision_item.porcentaje_aplicado|floatformat:2|default:"0.00" }}%</td>
                    <td>
                        {% if comision_item.factura_origen %}
                            <a href="{% url 'myapp:factura_detail' comision_item.factura_origen.pk %}">{{ comision_item.factura_origen.numero_recibo|default_if_none:"Ver Factura"|escape }}</a>
                        {% else %}N/A{% endif %}
                    </td>
                    <td>
                        {% if comision_item.tipo_comision == 'OVERRIDE' and comision_item.intermediario_vendedor %}
                            {{ comision_item.intermediario_vendedor.nombre_completo|escape|default:"N/A" }}
                        {% elif comision_item.tipo_comision == 'DIRECTA' %}
                            Propia
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge {% if comision_item.estatus_pago_comision == 'PAGADA' %}badge-success{% elif comision_item.estatus_pago_comision == 'PENDIENTE' %}badge-warning{% elif comision_item.estatus_pago_comision == 'ANULADA' %}badge-danger{% else %}badge-secondary{% endif %}">{{ comision_item.get_estatus_pago_comision_display|escape }}</span>
                    </td>
                    <td>{{ comision_item.fecha_calculo|date:"d/m/Y H:i"|default:"-" }}</td>
                    <td>{{ comision_item.fecha_pago_a_intermediario|date:"d/m/Y"|default:"-" }}</td>
                    <td class="actions">
                        <div class="action-group">
                            <a href="{% url 'myapp:registro_comision_detail' comision_item.pk %}" class="action-icon" title="Ver Detalles">üëÅÔ∏è</a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <div class="alert alert-info mt-3">
                {% if search_query %}
                No se encontraron comisiones que coincidan con la b√∫squeda para "{{ search_query|escape }}".
                {% else %}
                No tienes comisiones registradas en este momento.
                {% endif %}
            </div>
        {% endif %}
    </div>
    {% include "pagination.html" with preserved_filters=preserved_filters_for_pagination %} {# Pasar preserved_filters #}
  </section>
</div>
{% endblock %}