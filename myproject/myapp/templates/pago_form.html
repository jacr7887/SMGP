{% extends "base.html" %} {# Aseg√∫rate que 'base.html' sea tu plantilla base #}
{% load static %}
{% load humanize %} {# Necesario para intcomma si lo usas #}

{% block title %}{% if form.instance.pk %}Editar{% else %}Registrar{% endif %} Pago{% endblock %}

{# Cargar CSS/JS de Select2 si no est√° en base.html #}
{% block extra_head %}
    {% if form.media.css %}{{ form.media.css }}{% endif %}
{% endblock %}

{% block content %}
<div class="dark-container" role="main" aria-labelledby="main-heading">
  <section>
    <h1 id="main-heading" class="main-title">
      {% if form.instance.pk %}‚úèÔ∏è Editar{% else %}‚ûï Registrar{% endif %} Pago
    </h1>

    {# --- Botones de Acci√≥n Superiores --- #}
    <div class="header-actions mb-4"> {# A√±adido mb-4 para separaci√≥n #}
       {% if form.instance.pk %} {# Mostrar botones de PDF y eliminar solo si el pago existe #}
            <a href="{% url 'myapp:pago_pdf' pago.pk %}" target="_blank" class="btn btn-info">
              üìÑ Ver Recibo PDF
            </a>
            {% if perms.myapp.delete_pago %}
            <a href="{% url 'myapp:pago_delete' pago.pk %}" class="btn btn-danger delete-link">
              ‚ùå Eliminar
            </a>
            {% endif %}
        {% endif %}
        <a href="{% url 'myapp:pago_list' %}" class="nav_link"> 
            ‚¨ÖÔ∏è Volver al Listado
        </a>
    </div>

    {# --- Formulario Principal --- #}
    <form method="post" class="compact-form" enctype="multipart/form-data" aria-labelledby="form-instructions" novalidate>
      {% csrf_token %}

      {# --- Errores Generales --- #}
      {% if form.non_field_errors %}
          <div class="alert alert-danger error-summary">
              <h4>Errores Generales:</h4>
              <ul>
                  {% for error in form.non_field_errors %}
                      <li>{{ error|escape }}</li>
                  {% endfor %}
              </ul>
          </div>
      {% endif %}

      {# --- Fieldset: Informaci√≥n del Pago --- #}
      <fieldset> {# Quit√© dark-group #}
        <legend class="dark-label">üí∞ Informaci√≥n del Pago</legend>
        <div class="dark-grid"> {# Contenedor grid #}

            {# Campo activo #}
            <div class="dark-group {% if form.activo.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.activo.id_for_label }}">‚úÖ Registro Activo</label>
                <label class="switch">
                    {{ form.activo }}
                    <span class="slider"></span>
                </label>
                {% if form.activo.errors %}<ul class="error-messages">{% for error in form.activo.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                {% if form.activo.help_text %}<small class="form-text text-muted">{{ form.activo.help_text }}</small>{% endif %}
            </div>

            {# Campo fecha_pago #}
            <div class="dark-group {% if form.fecha_pago.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.fecha_pago.id_for_label }}">üìÖ Fecha Efectiva Pago</label>
                {{ form.fecha_pago }} {# Asume type=date #}
                {% if form.fecha_pago.errors %}<ul class="error-messages">{% for error in form.fecha_pago.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                {% if form.fecha_pago.help_text %}<small class="form-text text-muted">{{ form.fecha_pago.help_text }}</small>{% endif %}
            </div>

            {# Campo monto_pago #}
            <div class="dark-group {% if form.monto_pago.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.monto_pago.id_for_label }}">üí≤ Monto Pagado</label>
                {{ form.monto_pago }} {# Asume type=number #}
                {% if form.monto_pago.errors %}<ul class="error-messages">{% for error in form.monto_pago.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                {% if form.monto_pago.help_text %}<small class="form-text text-muted">{{ form.monto_pago.help_text }}</small>{% endif %}
            </div>

            {# Campo forma_pago #}
            <div class="dark-group {% if form.forma_pago.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.forma_pago.id_for_label }}">üí≥ Forma de Pago</label>
                {{ form.forma_pago }} {# Asume Select #}
                {% if form.forma_pago.errors %}<ul class="error-messages">{% for error in form.forma_pago.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                {% if form.forma_pago.help_text %}<small class="form-text text-muted">{{ form.forma_pago.help_text }}</small>{% endif %}
            </div>

            {# Campo referencia_pago #}
            <div class="dark-group {% if form.referencia_pago.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.referencia_pago.id_for_label }}">#Ô∏è‚É£ Referencia Pago</label>
                {{ form.referencia_pago }} {# Asume TextInput #}
                {% if form.referencia_pago.errors %}<ul class="error-messages">{% for error in form.referencia_pago.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                {% if form.referencia_pago.help_text %}<small class="form-text text-muted">{{ form.referencia_pago.help_text }}</small>{% endif %}
            </div>

        </div> {# Fin dark-grid #}
      </fieldset>

      {# --- Fieldset: Asociaci√≥n --- #}
      <fieldset>
          <legend class="dark-label">üîó Asociaci√≥n</legend>
          <div class="dark-grid">
              {# Campo factura #}
              <div class="dark-group {% if form.factura.errors %}error{% endif %}">
                  <label class="dark-label" for="{{ form.factura.id_for_label }}">üßæ Factura Asociada (Opcional)</label>
                  {{ form.factura }} {# Asume Select2Widget #}
                  {% if form.factura.errors %}<ul class="error-messages">{% for error in form.factura.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                  {% if form.factura.help_text %}<small class="form-text text-muted">{{ form.factura.help_text }}</small>{% endif %}
              </div>

              {# Campo reclamacion #}
              <div class="dark-group {% if form.reclamacion.errors %}error{% endif %}">
                  <label class="dark-label" for="{{ form.reclamacion.id_for_label }}">üìã Reclamaci√≥n Asociada (Opcional)</label>
                  {{ form.reclamacion }} {# Asume Select2Widget #}
                  {% if form.reclamacion.errors %}<ul class="error-messages">{% for error in form.reclamacion.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                  {% if form.reclamacion.help_text %}<small class="form-text text-muted">{{ form.reclamacion.help_text }}</small>{% endif %}
              </div>
          </div>
      </fieldset>

      {# --- Fieldset: Detalles Adicionales --- #}
      <fieldset>
        <legend class="dark-label">‚ÑπÔ∏è Detalles Adicionales</legend>
        <div class="dark-grid">

            {# Campo fecha_notificacion_pago #}
            <div class="dark-group {% if form.fecha_notificacion_pago.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.fecha_notificacion_pago.id_for_label }}">üîî Fecha Notificaci√≥n (Opcional)</label>
                {{ form.fecha_notificacion_pago }} {# Asume type=date #}
                {% if form.fecha_notificacion_pago.errors %}<ul class="error-messages">{% for error in form.fecha_notificacion_pago.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                {% if form.fecha_notificacion_pago.help_text %}<small class="form-text text-muted">{{ form.fecha_notificacion_pago.help_text }}</small>{% endif %}
            </div>

            {# --- NUEVO CAMPO: aplica_igtf_pago (Switch) --- #}
            <div class="dark-group {% if form.aplica_igtf_pago.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.aplica_igtf_pago.id_for_label }}">üí≤ {{ form.aplica_igtf_pago.label }}</label>
                <label class="switch"> {# Label envolvente para el estilo switch #}
                    {{ form.aplica_igtf_pago }} {# Renderiza el input checkbox #}
                    <span class="slider"></span> {# Span para el estilo CSS #}
                </label>
                {% if form.aplica_igtf_pago.errors %}<ul class="error-messages">{% for error in form.aplica_igtf_pago.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                {% if form.aplica_igtf_pago.help_text %}<small class="form-text text-muted">{{ form.aplica_igtf_pago.help_text }}</small>{% endif %}
            </div>
            {# --- FIN NUEVO CAMPO --- #}

            {# Campo observaciones_pago (Ocupando m√°s espacio) #}
            <div class="dark-group {% if form.observaciones_pago.errors %}error{% endif %}" style="grid-column: 1 / -1;"> {# Ocupa todas las columnas disponibles #}
                <label class="dark-label" for="{{ form.observaciones_pago.id_for_label }}">üìù Observaciones</label>
                {{ form.observaciones_pago }} {# Asume Textarea #}
                {% if form.observaciones_pago.errors %}<ul class="error-messages">{% for error in form.observaciones_pago.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                {% if form.observaciones_pago.help_text %}<small class="form-text text-muted">{{ form.observaciones_pago.help_text }}</small>{% endif %}
            </div>

            {# --- Campo documentos_soporte_pago (con label tipo bot√≥n) --- #}
            <div class="dark-group {% if form.documentos_soporte_pago.errors %}error{% endif %}" style="grid-column: 1 / -1;">
                {# Etiqueta principal visible (opcional, puedes quitarla si el bot√≥n es suficiente) #}
                {# <label class="dark-label">üìé Documento Soporte (Opcional)</label> #}
      
                {# Renderizar el input file (estar√° oculto o estilizado por CSS/JS) #}
                {{ form.documentos_soporte_pago }}
      
                {# Etiqueta que act√∫a como bot√≥n - ¬°Aseg√∫rate que el 'for' coincida con el ID del input real! #}
                <label for="{{ form.documentos_soporte_pago.id_for_label }}" class="btn file-button" style="display: inline-block; margin-top: 5px; cursor: pointer;">
                    üìé Seleccionar Archivo
                </label>
      
                {# Mostrar nombre del archivo actual si existe #}
                {% if form.instance.documentos_soporte_pago %}
                    <p style="margin-top: 0.5rem; font-size: 0.9rem; display: inline-block; margin-left: 10px;">
                        Archivo actual:
                        <a href="{{ form.instance.documentos_soporte_pago.url }}" target="_blank">
                            {{ form.instance.documentos_soporte_pago.name|cut:"documentos_pagos/" }}
                        </a>
                        {# Considerar a√±adir checkbox para borrar #}
                    </p>
                {% endif %}
      
                {# Mostrar errores y texto de ayuda #}
                {% if form.documentos_soporte_pago.errors %}
                    <ul class="error-messages" style="display: block; margin-top: 5px;">
                        {% for error in form.documentos_soporte_pago.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
                {% if form.documentos_soporte_pago.help_text %}
                    <small class="form-text text-muted" style="display: block; margin-top: 5px;">
                        {{ form.documentos_soporte_pago.help_text }}
                    </small>
                {% endif %}
            </div>
            {# --- Fin Campo documentos_soporte_pago --- #}
      
        </div> {# Fin dark-grid #}
      </fieldset>

      {# Renderizar campos ocultos #}
      {% for field in form.hidden_fields %}
          {{ field }}
      {% endfor %}

      {# --- Botones de Acci√≥n Inferiores --- #}
      <div class="form-actions">
        <button type="submit" class="btn btn-success">{% if form.instance.pk %}üíæ Actualizar Pago{% else %}‚ûï Registrar Pago{% endif %}</button>
        <a href="{% url 'myapp:pago_list' %}" class="btn btn-danger">üö´ Cancelar</a>
      </div>
    </form>
  </section>
</div>

{% endblock content %}

{# --- Bloque extra_scripts (si no est√° en base.html) --- #}
{% block extra_scripts %}
    {# Si jQuery y form.media.js NO est√°n en base.html, c√°rgalos aqu√≠ #}
    {# <script src="{% static 'jquery-3.7.1.min.js' %}"></script> #}
    {# {% if form.media.js %}{{ form.media.js }}{% endif %} #}
{% endblock %}