{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% load querystring_tags %}

{% block content %}
<div class="dark-container" role="main" aria-labelledby="main-heading">
  <section>
    <h1 id="main-heading">
      {% if form.instance.pk %}‚úèÔ∏è Editar{% else %}‚ûï Nuevo{% endif %} Contrato Colectivo
      {% if form.instance.pk %}: {{ form.instance.numero_contrato|default:"(Sin n√∫mero)" }}{% endif %}
    </h1>

    <div class="header-actions">
       {% if perms.myapp.view_contratocolectivo %}
           <a href="{% url 'myapp:contrato_colectivo_list' %}" class="nav_link" aria-label="Volver al listado de contratos colectivos">
               ‚¨ÖÔ∏è Volver al Listado
           </a>
       {% endif %}
       {% if form.instance.pk and perms.myapp.view_contratocolectivo %}
            <a href="{% url 'myapp:contrato_colectivo_detail' form.instance.pk %}" class="nav_link" aria-label="Ver detalles de este contrato">
                üëÅÔ∏è Ver Detalle
            </a>
       {% endif %}
    </div>

    <form method="post" class="compact-form" enctype="multipart/form-data" aria-labelledby="main-heading" novalidate>
      {% csrf_token %}

      {% if form.non_field_errors %}
          <div class="alert alert-danger error-summary" role="alert">
              <h4>‚ö†Ô∏è Errores Generales:</h4>
              <ul>
                  {% for error in form.non_field_errors %}
                      <li>{{ error|escape }}</li>
                  {% endfor %}
              </ul>
          </div>
      {% endif %}

      {# --- Fieldset Empresa Contratante --- #}
      <fieldset class="dark-group" data-section="informacion-empresa">
        <legend class="dark-label">üè¢ Informaci√≥n de la Empresa Contratante</legend>
        <div class="dark-grid">
            {% if form.instance.pk %}
                <div class="dark-group readonly-group">
                    <label class="dark-label">üè∑Ô∏è Raz√≥n Social (Copiada)</label>
                    <input type="text" value="{{ form.instance.razon_social|default:'N/A' }}" readonly class="dark-group-plaintext">
                </div>
                <div class="dark-group readonly-group">
                    <label class="dark-label">üìÑ RIF (Copiado)</label>
                    <input type="text" value="{{ form.instance.rif|default:'N/A' }}" readonly class="dark-group-plaintext">
                </div>
            {% endif %}

            {% if 'tipo_empresa' in form.fields %} {# Cambiado a if 'campo' in form.fields #}
            <div class="dark-group {% if form.tipo_empresa.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.tipo_empresa.id_for_label }}">üè≠ Tipo de Empresa</label>
                {{ form.tipo_empresa }}
                {% for error in form.tipo_empresa.errors %}<ul class="error-messages" role="alert"><li>{{ error|escape }}</li></ul>{% endfor %}
                {% if form.tipo_empresa.help_text %}<small class="form-text text-muted">{{ form.tipo_empresa.help_text|escape }}</small>{% endif %}
            </div>
            {% endif %}

            {% if 'cantidad_empleados' in form.fields %}
            <div class="dark-group {% if form.cantidad_empleados.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.cantidad_empleados.id_for_label }}">üë• Cantidad Empleados</label>
                {{ form.cantidad_empleados }}
                {% for error in form.cantidad_empleados.errors %}<ul class="error-messages" role="alert"><li>{{ error|escape }}</li></ul>{% endfor %}
                {% if form.cantidad_empleados.help_text %}<small class="form-text text-muted">{{ form.cantidad_empleados.help_text|escape }}</small>{% endif %}
            </div>
            {% endif %}
            
            {% if 'direccion_comercial' in form.fields %}
            <div class="dark-group {% if form.direccion_comercial.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.direccion_comercial.id_for_label }}">üè† Direcci√≥n Comercial</label>
                {{ form.direccion_comercial }}
                {% for error in form.direccion_comercial.errors %}<ul class="error-messages" role="alert"><li>{{ error|escape }}</li></ul>{% endfor %}
                {% if form.direccion_comercial.help_text %}<small class="form-text text-muted">{{ form.direccion_comercial.help_text|escape }}</small>{% endif %}
            </div>
            {% endif %}

            {% if 'zona_postal' in form.fields %}
            <div class="dark-group {% if form.zona_postal.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.zona_postal.id_for_label }}">üì¨ Zona Postal</label>
                {{ form.zona_postal }}
                {% for error in form.zona_postal.errors %}<ul class="error-messages" role="alert"><li>{{ error|escape }}</li></ul>{% endfor %}
                {% if form.zona_postal.help_text %}<small class="form-text text-muted">{{ form.zona_postal.help_text|escape }}</small>{% endif %}
            </div>
            {% endif %}
        </div>
      </fieldset>

      {# --- Fieldset Informaci√≥n del Contrato Colectivo --- #}
      <fieldset class="dark-group" data-section="informacion-contrato">
        <legend class="dark-label">üìÑ Informaci√≥n del Contrato Colectivo</legend>
        <div class="dark-grid">
            {% if form.instance.pk %}
                <div class="dark-group readonly-group"><label class="dark-label">#Ô∏è‚É£ N√∫mero Contrato</label><input type="text" value="{{ form.instance.numero_contrato|default:'N/A' }}" readonly class="dark-group-plaintext"></div>
                <div class="dark-group readonly-group"><label class="dark-label">üìú N√∫mero P√≥liza</label><input type="text" value="{{ form.instance.numero_poliza|default:'N/A' }}" readonly class="dark-group-plaintext"></div>
                <div class="dark-group readonly-group"><label class="dark-label">üìú N√∫mero Certificado</label><input type="text" value="{{ form.instance.certificado|default:'N/A' }}" readonly class="dark-group-plaintext"></div>
                <div class="dark-group readonly-group"><label class="dark-label">üßæ N√∫mero Recibo Global</label><input type="text" value="{{ form.instance.numero_recibo|default:'N/A' }}" readonly class="dark-group-plaintext"></div>
                <div class="dark-group readonly-group"><label class="dark-label">üìÖ Fecha Emisi√≥n (Registrada)</label><input type="text" value="{{ form.instance.fecha_emision|date:"d/m/Y H:i"|default:'N/A' }}" readonly class="dark-group-plaintext"></div>
                <div class="dark-group readonly-group"><label class="dark-label">üí∞ Prima Total (Calculada)</label><input type="text" value="${{ form.instance.monto_total|floatformat:2|intcomma|default:'0.00' }}" readonly class="dark-group-plaintext"><small class="form-text text-muted">Monto hist√≥rico calculado.</small></div>
            {% endif %}

            {% if 'activo' in form.fields %}
            <div class="dark-group form-field-inline {% if form.activo.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.activo.id_for_label }}">üí° Activo</label>
                 <label class="switch">
                     {{ form.activo }}
                     <span class="slider"></span>
                 </label>
                {% for error in form.activo.errors %}<ul class="error-messages" role="alert"><li>{{ error|escape }}</li></ul>{% endfor %}
                {% if form.activo.help_text %}<small class="form-text text-muted">{{ form.activo.help_text|escape }}</small>{% endif %}
            </div>
            {% endif %}

            {% if 'ramo' in form.fields %}
            <div class="dark-group {% if form.ramo.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.ramo.id_for_label }}">üåø Ramo {% if form.ramo.field.required %}(*){% endif %}</label>
                {{ form.ramo }}
                {% for error in form.ramo.errors %}<ul class="error-messages" role="alert"><li>{{ error|escape }}</li></ul>{% endfor %}
                {% if form.ramo.help_text %}<small class="form-text text-muted">{{ form.ramo.help_text|escape }}</small>{% endif %}
            </div>
            {% endif %}

            {% if 'plan_contratado' in form.fields %}
            <div class="dark-group {% if form.plan_contratado.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.plan_contratado.id_for_label }}">üìã Plan Contratado</label>
                {{ form.plan_contratado }}
                {% for error in form.plan_contratado.errors %}<ul class="error-messages" role="alert"><li>{{ error|escape }}</li></ul>{% endfor %}
                {% if form.plan_contratado.help_text %}<small class="form-text text-muted">{{ form.plan_contratado.help_text|escape }}</small>{% endif %}
            </div>
            {% endif %}

            {% if 'suma_asegurada' in form.fields %}
            <div class="dark-group {% if form.suma_asegurada.errors %}error{% endif %}">
               <label class="dark-label" for="{{ form.suma_asegurada.id_for_label }}">üõ°Ô∏è Suma Asegurada / Cobertura</label>
               {{ form.suma_asegurada }}
               {% for error in form.suma_asegurada.errors %}<ul class="error-messages" role="alert"><li>{{ error|escape }}</li></ul>{% endfor %}
               {% if form.suma_asegurada.help_text %}<small class="form-text text-muted">{{ form.suma_asegurada.help_text|escape }}</small>{% endif %}
           </div>
           {% endif %}

            {% if 'intermediario' in form.fields %}
            <div class="dark-group {% if form.intermediario.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.intermediario.id_for_label }}">ü§ù Intermediario {% if form.intermediario.field.required %}(*){% endif %}</label>
                {{ form.intermediario }}
                {% for error in form.intermediario.errors %}<ul class="error-messages" role="alert"><li>{{ error|escape }}</li></ul>{% endfor %}
                {% if form.intermediario.help_text %}<small class="form-text text-muted">{{ form.intermediario.help_text|escape }}</small>{% endif %}
            </div>
            {% endif %}
            
            {% if 'tarifa_aplicada' in form.fields %}
            <div class="dark-group {% if form.tarifa_aplicada.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.tarifa_aplicada.id_for_label }}">üè∑Ô∏è Tarifa Aplicada {% if form.tarifa_aplicada.field.required %}(*){% endif %}</label>
                {{ form.tarifa_aplicada }}
                {% for error in form.tarifa_aplicada.errors %}<ul class="error-messages"><li>{{ error|escape }}</li></ul>{% endfor %}
                {% if form.tarifa_aplicada.help_text %}<small class="form-text text-muted">{{ form.tarifa_aplicada.help_text|escape }}</small>{% endif %}
            </div>
            {% endif %}
        </div>
      </fieldset>

      {# --- Fieldset Condiciones Financieras y Vigencia --- #}
      <fieldset class="dark-group" data-section="condiciones-financieras">
        <legend class="dark-label">üí∞ Condiciones Financieras y Vigencia</legend>
        <div class="dark-grid">
            {% if 'forma_pago' in form.fields %}
            <div class="dark-group {% if form.forma_pago.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.forma_pago.id_for_label }}">üí≥ Forma de Pago {% if form.forma_pago.field.required %}(*){% endif %}</label>
                {{ form.forma_pago }}
                {% for error in form.forma_pago.errors %}<ul class="error-messages" role="alert"><li>{{ error|escape }}</li></ul>{% endfor %}
                {% if form.forma_pago.help_text %}<small class="form-text text-muted">{{ form.forma_pago.help_text|escape }}</small>{% endif %}
            </div>
            {% endif %}

            {% if 'periodo_vigencia_meses' in form.fields %}
            <div class="dark-group {% if form.periodo_vigencia_meses.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.periodo_vigencia_meses.id_for_label }}">‚è≥ Duraci√≥n (Meses)</label>
                {{ form.periodo_vigencia_meses }}
                {% for error in form.periodo_vigencia_meses.errors %}<ul class="error-messages" role="alert"><li>{{ error|escape }}</li></ul>{% endfor %}
                {% if form.periodo_vigencia_meses.help_text %}<small class="form-text text-muted">{{ form.periodo_vigencia_meses.help_text|escape }}</small>{% endif %}
            </div>
            {% endif %}

            {# ***** INICIO CORRECCI√ìN PARA FECHA DE EMISI√ìN ***** #}
            {% if not form.instance.pk and 'fecha_emision' in form.fields %} {# Solo en modo CREACI√ìN #}
            <div class="dark-group {% if form.fecha_emision.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.fecha_emision.id_for_label }}">üìÖ Fecha de Emisi√≥n {% if form.fecha_emision.field.required %}(*){% endif %}</label>
                {{ form.fecha_emision }} {# Renderiza el campo del formulario #}
                {% for error in form.fecha_emision.errors %}<ul class="error-messages" role="alert"><li>{{ error|escape }}</li></ul>{% endfor %}
                {% if form.fecha_emision.help_text %}<small class="form-text text-muted">{{ form.fecha_emision.help_text|escape }}</small>{% endif %}
            </div>
            {% endif %}
            {# ***** FIN CORRECCI√ìN PARA FECHA DE EMISI√ìN ***** #}

            {% if 'fecha_inicio_vigencia' in form.fields %}
            <div class="dark-group {% if form.fecha_inicio_vigencia.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.fecha_inicio_vigencia.id_for_label }}">‚û°Ô∏è Inicio Vigencia {% if form.fecha_inicio_vigencia.field.required %}(*){% endif %}</label>
                {{ form.fecha_inicio_vigencia }}
                {% for error in form.fecha_inicio_vigencia.errors %}<ul class="error-messages" role="alert"><li>{{ error|escape }}</li></ul>{% endfor %}
                {% if form.fecha_inicio_vigencia.help_text %}<small class="form-text text-muted">{{ form.fecha_inicio_vigencia.help_text|escape }}</small>{% endif %}
            </div>
            {% endif %}

            {% if 'fecha_fin_vigencia' in form.fields %}
            <div class="dark-group {% if form.fecha_fin_vigencia.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.fecha_fin_vigencia.id_for_label }}">‚èπÔ∏è Fin Vigencia</label>
                {{ form.fecha_fin_vigencia }}
                {% for error in form.fecha_fin_vigencia.errors %}<ul class="error-messages" role="alert"><li>{{ error|escape }}</li></ul>{% endfor %}
                {% if form.fecha_fin_vigencia.help_text %}<small class="form-text text-muted">{{ form.fecha_fin_vigencia.help_text|escape }}</small>{% endif %}
            </div>
            {% endif %}
            
            {% if 'estatus' in form.fields %}
            <div class="dark-group {% if form.estatus.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.estatus.id_for_label }}">üö¶ Estatus Vigencia</label>
                {{ form.estatus }}
                {% for error in form.estatus.errors %}<ul class="error-messages" role="alert"><li>{{ error|escape }}</li></ul>{% endfor %}
                {% if form.estatus.help_text %}<small class="form-text text-muted">{{ form.estatus.help_text|escape }}</small>{% endif %}
            </div>
            {% endif %}

            {% if 'estado_contrato' in form.fields %}
            <div class="dark-group {% if form.estado_contrato.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.estado_contrato.id_for_label }}">üìä Estado Admin.</label>
                {{ form.estado_contrato }}
                {% for error in form.estado_contrato.errors %}<ul class="error-messages" role="alert"><li>{{ error|escape }}</li></ul>{% endfor %}
                {% if form.estado_contrato.help_text %}<small class="form-text text-muted">{{ form.estado_contrato.help_text|escape }}</small>{% endif %}
            </div>
            {% endif %}

            {% if form.instance.pk %} {# Campos calculados solo en edici√≥n #}
                 <div class="dark-group readonly-group"><label class="dark-label">üî¢ Cuotas Calculadas</label><input type="text" value="{{ form.instance.cantidad_cuotas_estimadas|default:'N/A' }}" readonly class="dark-group-plaintext"></div>
                 <div class="dark-group readonly-group"><label class="dark-label">üíµ Importe Cuota (Calculado)</label><input type="text" value="${{ form.instance.monto_cuota_estimada|floatformat:2|intcomma|default:'N/A' }}" readonly class="dark-group-plaintext"></div>
                 <div class="dark-group readonly-group"><label class="dark-label">üìÖ Importe Anual (Ref.)</label><input type="text" value="${{ form.instance.importe_anual_contrato|floatformat:2|intcomma|default:'N/A' }}" readonly class="dark-group-plaintext"></div>
                 <div class="dark-group readonly-group"><label class="dark-label">‚úÖ Pagos Realizados</label><input type="text" value="{{ form.instance.pagos_realizados|default:'0' }}" readonly class="dark-group-plaintext"></div>
            {% endif %}
        </div>
        
        <!-- INICIO DE LA SOLUCI√ìN: VISTA PREVIA DEL MONTO -->
        <div class="dark-group" style="grid-column: 1 / -1; margin-top: 1rem;">
            <h4 class="dark-label" style="font-size: 1.1em; margin-bottom: 0.5rem;">Monto Total Estimado del Contrato:</h4>
            <p style="font-size: 1.5em; margin: 0;">
                <span id="monto-total-display" style="font-weight: bold; color: #28a745;">$0.00</span>
            </p>
            <small class="form-text text-muted">
                Este monto es una vista previa y se calcular√° y guardar√° definitivamente en el servidor.
            </small>
        </div>
        <!-- FIN DE LA SOLUCI√ìN -->

      </fieldset>

      {% if 'afiliados_colectivos' in form.fields %} {# Movido aqu√≠ para mejor flujo visual #}
      <fieldset class="dark-group" data-section="afiliados-asociados">
           <legend class="dark-label">üè¢ Empresas Afiliadas Asociadas {% if form.afiliados_colectivos.field.required %}(*){% endif %}</legend>
           <div class="dark-group {% if form.afiliados_colectivos.errors %}error{% endif %}">
               {{ form.afiliados_colectivos }}
               {% for error in form.afiliados_colectivos.errors %}<ul class="error-messages" role="alert"><li>{{ error|escape }}</li></ul>{% endfor %}
               {% if form.afiliados_colectivos.help_text %}<small class="form-text text-muted">{{ form.afiliados_colectivos.help_text|escape }}</small>{% endif %}
           </div>
       </fieldset>
       {% endif %}

      <fieldset class="dark-group" data-section="otros-detalles">
        <legend class="dark-label">‚ÑπÔ∏è Otros Detalles</legend>
        <div class="dark-grid">
            {% if 'criterio_busqueda' in form.fields %}
            <div class="dark-group {% if form.criterio_busqueda.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.criterio_busqueda.id_for_label }}">üîç Criterio B√∫squeda</label>
                {{ form.criterio_busqueda }}
                {% for error in form.criterio_busqueda.errors %}<ul class="error-messages" role="alert"><li>{{ error|escape }}</li></ul>{% endfor %}
                {% if form.criterio_busqueda.help_text %}<small class="form-text text-muted">{{ form.criterio_busqueda.help_text|escape }}</small>{% endif %}
            </div>
            {% endif %}

            {% if 'codigo_validacion' in form.fields %} {# Este campo no est√° en tu form.Meta.fields #}
            {# Si quieres mostrarlo (readonly), debes a√±adirlo al form y luego aqu√≠ #}
            {# <div class="dark-group {% if form.codigo_validacion.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.codigo_validacion.id_for_label }}">üîë C√≥d. Validaci√≥n</label>
                {{ form.codigo_validacion }}
                ...
            </div> #}
            {% endif %}

            {% if 'consultar_afiliados_activos' in form.fields %}
            <div class="dark-group form-field-inline {% if form.consultar_afiliados_activos.errors %}error{% endif %}">
                <label class="dark-label" for="{{ form.consultar_afiliados_activos.id_for_label }}">‚ùì Consultar Af. Activos</label>
                 <label class="switch">
                    {{ form.consultar_afiliados_activos }}
                     <span class="slider"></span>
                 </label>
                {% for error in form.consultar_afiliados_activos.errors %}<ul class="error-messages" role="alert"><li>{{ error|escape }}</li></ul>{% endfor %}
                {% if form.consultar_afiliados_activos.help_text %}<small class="form-text text-muted">{{ form.consultar_afiliados_activos.help_text|escape }}</small>{% endif %}
            </div>
            {% endif %}
        </div>
      </fieldset>

       {% for field in form.hidden_fields %}
            {{ field }}
       {% endfor %}

      <div class="form-actions">
        <button type="submit" class="btn-success">{% if form.instance.pk %}üíæ Actualizar Contrato{% else %}‚ûï Crear Contrato{% endif %}</button>
        <a href="{% url 'myapp:contrato_colectivo_list' %}" class="btn-danger">üö´ Cancelar</a>
      </div>
    </form>
  </section>
</div>
{% comment %} 
<style>
  .readonly-group { margin-bottom: 0.8rem; }
  .dark-group-plaintext {
    display: block; width: 100%; padding: 0.375rem 0.1rem;
    margin-bottom: 0; line-height: 1.5; color: #bdc3c7;
    background-color: transparent; border: none; border-bottom: 1px solid #444;
    box-sizing: border-box; font-size: 0.9em;
  }
  .dark-group.readonly-group small { display: block; margin-top: 0.25rem; font-size: 0.8em; }
  .switch { position: relative; display: inline-block; width: 50px; height: 24px; vertical-align: middle; margin-left: 10px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 24px; }
  .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: #4CAF50; }
  input:checked + .slider:before { transform: translateX(26px); }
  .dark-group.error input, .dark-group.error select, .dark-group.error textarea { border-color: #e74c3c; }
  .error-messages { list-style: none; padding-left: 0; margin-top: 0.25rem; }
  .error-messages li { color: #e74c3c; font-size: 0.85em; }
  .error-summary { margin-bottom: 1.5rem; }
  .error-summary h4 { color: #e74c3c; margin-bottom: 0.5rem; font-size: 1.1em; }
  .error-summary ul { padding-left: 20px; margin-bottom: 0; }
  .error-summary li { color: #f1a097; }
</style>
{% endcomment %}
{% endblock content %}